<!-- Drawing Canvas Component
     Usage: Copy into lesson HTML. Freeform drawing/annotation tool.
     Requires: base.css for foundation styles.

     HOW IT WORKS:
     - HTML5 Canvas element for freeform drawing
     - Toolbar: pen, eraser, color picker (5 presets), size slider (3 sizes)
     - Mouse + touch support (stylus-friendly)
     - Undo button stores last 10 strokes
     - Clear all button with confirmation
     - Save drawing as data URL for assessment submission
     - Optional background image to draw/annotate on
     - Responsive canvas sizing

     CUSTOMIZATION:
     - Edit COLORS array for preset colors
     - Set BG_IMAGE to add a background image for annotation
     - Adjust MAX_UNDO for undo history depth
     - Set CANVAS_WIDTH/CANVAS_HEIGHT for resolution

     ACCESSIBILITY:
     - Toolbar buttons with aria-labels
     - Keyboard: Tab through tools, shortcut keys (P=pen, E=eraser, U=undo, C=clear)
     - Screen reader: announces tool changes
     - Color choices have descriptive labels

     SCORM REPORTING:
     - Save canvas.toDataURL() to cmi.suspend_data for persistence
     - Or submit as interaction response
-->

<style>
  /* === Drawing Canvas Container === */
  .drawing-canvas {
    max-width: 800px;
    margin: 0 auto;
  }

  /* Toolbar */
  .dc-toolbar {
    display: flex;
    align-items: center;
    gap: var(--space-sm, 8px);
    padding: var(--space-sm, 8px) var(--space-md, 16px);
    background: var(--color-surface-elevated, #f5f5f5);
    border-radius: var(--radius-md, 8px) var(--radius-md, 8px) 0 0;
    border: 2px solid var(--color-border, #e0e0e0);
    border-bottom: none;
    flex-wrap: wrap;
  }

  .dc-toolbar-group {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .dc-toolbar-divider {
    width: 1px;
    height: 28px;
    background: var(--color-border, #ddd);
    margin: 0 var(--space-sm, 8px);
  }

  /* Tool buttons */
  .dc-tool-btn {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-sm, 4px);
    border: 2px solid transparent;
    background: var(--color-surface, #fff);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    transition: border-color 0.2s, background 0.2s;
    min-height: 44px;
    min-width: 44px;
  }

  .dc-tool-btn:hover {
    border-color: var(--color-primary, #6c5ce7);
  }

  .dc-tool-btn:focus-visible {
    outline: 3px solid var(--color-primary, #6c5ce7);
    outline-offset: 2px;
  }

  .dc-tool-btn.active {
    border-color: var(--color-primary, #6c5ce7);
    background: var(--color-growth-bg, #f0f0ff);
  }

  /* Color buttons */
  .dc-color-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: border-color 0.2s, transform 0.15s;
    min-height: 44px;
    min-width: 44px;
    padding: 6px;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .dc-color-btn .dc-color-swatch {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    min-width: 20px;
    min-height: 20px;
  }

  .dc-color-btn:hover {
    transform: scale(1.1);
  }

  .dc-color-btn.active {
    border-color: var(--color-text-primary, #333);
  }

  .dc-color-btn:focus-visible {
    outline: 3px solid var(--color-primary, #6c5ce7);
    outline-offset: 2px;
  }

  /* Size selector */
  .dc-size-btn {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-sm, 4px);
    border: 2px solid transparent;
    background: var(--color-surface, #fff);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border-color 0.2s;
    min-height: 44px;
    min-width: 44px;
  }

  .dc-size-btn:hover {
    border-color: var(--color-primary, #6c5ce7);
  }

  .dc-size-btn.active {
    border-color: var(--color-primary, #6c5ce7);
    background: var(--color-growth-bg, #f0f0ff);
  }

  .dc-size-btn:focus-visible {
    outline: 3px solid var(--color-primary, #6c5ce7);
    outline-offset: 2px;
  }

  .dc-size-dot {
    border-radius: 50%;
    background: var(--color-text-primary, #333);
  }

  /* Canvas area */
  .dc-canvas-wrap {
    position: relative;
    border: 2px solid var(--color-border, #e0e0e0);
    border-top: none;
    border-radius: 0 0 var(--radius-md, 8px) var(--radius-md, 8px);
    overflow: hidden;
    touch-action: none; /* Prevent scroll while drawing */
    background: #fff;
  }

  .dc-canvas-wrap canvas {
    display: block;
    width: 100%;
    height: auto;
    cursor: crosshair;
  }

  /* Action bar below canvas */
  .dc-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: var(--space-sm, 8px);
    flex-wrap: wrap;
    gap: var(--space-sm, 8px);
  }

  .dc-action-btn {
    padding: 8px 16px;
    border: 2px solid var(--color-border, #e0e0e0);
    border-radius: var(--radius-md, 8px);
    background: var(--color-surface-elevated, #f5f5f5);
    cursor: pointer;
    font-size: 0.8rem;
    font-family: inherit;
    min-height: 44px;
    transition: border-color 0.2s, background 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .dc-action-btn:hover {
    border-color: var(--color-primary, #6c5ce7);
    background: var(--color-growth-bg, #f0f0ff);
  }

  .dc-action-btn.save {
    background: var(--color-primary, #6c5ce7);
    color: #fff;
    border-color: var(--color-primary, #6c5ce7);
  }

  .dc-action-btn.save:hover {
    opacity: 0.9;
  }

  /* === Reduced Motion === */
  @media (prefers-reduced-motion: reduce) {
    .dc-color-btn:hover { transform: none; }
  }
</style>

<div class="drawing-canvas" role="application" aria-label="Drawing canvas for annotations">

  <!-- Toolbar -->
  <div class="dc-toolbar" role="toolbar" aria-label="Drawing tools">
    <!-- Tool buttons -->
    <div class="dc-toolbar-group" role="radiogroup" aria-label="Drawing mode">
      <button class="dc-tool-btn active" data-tool="pen" aria-label="Pen tool (P)" title="Pen (P)">
        &#9999;
      </button>
      <button class="dc-tool-btn" data-tool="eraser" aria-label="Eraser tool (E)" title="Eraser (E)">
        &#128465;
      </button>
    </div>

    <div class="dc-toolbar-divider" aria-hidden="true"></div>

    <!-- Colors -->
    <div class="dc-toolbar-group" id="dc-colors" role="radiogroup" aria-label="Color picker">
      <!-- Populated by JS -->
    </div>

    <div class="dc-toolbar-divider" aria-hidden="true"></div>

    <!-- Sizes -->
    <div class="dc-toolbar-group" id="dc-sizes" role="radiogroup" aria-label="Brush size">
      <!-- Populated by JS -->
    </div>
  </div>

  <!-- Canvas -->
  <div class="dc-canvas-wrap">
    <canvas id="dc-canvas" width="800" height="450"></canvas>
  </div>

  <!-- Actions -->
  <div class="dc-actions">
    <div>
      <button class="dc-action-btn" id="dc-undo" aria-label="Undo last stroke (Ctrl+Z)">
        &#8617; Undo
      </button>
      <button class="dc-action-btn" id="dc-clear" aria-label="Clear canvas">
        &#128465; Clear
      </button>
    </div>
    <button class="dc-action-btn save" id="dc-save" aria-label="Save drawing">
      &#128190; Save Drawing
    </button>
  </div>
</div>

<div id="dc-announce" class="sr-only" aria-live="polite"></div>

<script>
/* ============================================================
   DRAWING CANVAS COMPONENT
   ============================================================
   Freeform drawing with pen, eraser, colors, and sizes.
   ============================================================ */

(function() {
  /* === CUSTOMIZE === */
  var COLORS = [
    { value: '#333333', label: 'Black' },
    { value: '#ef4444', label: 'Red' },
    { value: '#3b82f6', label: 'Blue' },
    { value: '#10b981', label: 'Green' },
    { value: '#f59e0b', label: 'Orange' }
  ];

  var SIZES = [
    { value: 2,  label: 'Small',  dotSize: 6 },
    { value: 5,  label: 'Medium', dotSize: 10 },
    { value: 12, label: 'Large',  dotSize: 16 }
  ];

  var MAX_UNDO = 10;
  /* Set to an image URL to use as annotation background */
  var BG_IMAGE = null; /* e.g., 'diagram.png' */

  /* === State === */
  var currentTool = 'pen';
  var currentColor = COLORS[0].value;
  var currentSize = SIZES[1].value;
  var isDrawing = false;
  var undoStack = [];

  var canvas = document.getElementById('dc-canvas');
  var ctx = canvas.getContext('2d');
  var colorsEl = document.getElementById('dc-colors');
  var sizesEl = document.getElementById('dc-sizes');

  /* === Build color buttons === */
  COLORS.forEach(function(c, i) {
    var btn = document.createElement('button');
    btn.className = 'dc-color-btn' + (i === 0 ? ' active' : '');
    btn.dataset.color = c.value;
    btn.setAttribute('aria-label', c.label);
    btn.setAttribute('role', 'radio');
    btn.setAttribute('aria-checked', i === 0 ? 'true' : 'false');
    btn.innerHTML = '<span class="dc-color-swatch" style="background:' + c.value + '"></span>';
    btn.addEventListener('click', function() {
      selectColor(c.value, btn);
    });
    colorsEl.appendChild(btn);
  });

  /* === Build size buttons === */
  SIZES.forEach(function(s, i) {
    var btn = document.createElement('button');
    btn.className = 'dc-size-btn' + (i === 1 ? ' active' : '');
    btn.dataset.size = s.value;
    btn.setAttribute('aria-label', s.label + ' brush');
    btn.setAttribute('role', 'radio');
    btn.setAttribute('aria-checked', i === 1 ? 'true' : 'false');
    btn.innerHTML = '<span class="dc-size-dot" style="width:' + s.dotSize + 'px;height:' + s.dotSize + 'px"></span>';
    btn.addEventListener('click', function() {
      selectSize(s.value, btn);
    });
    sizesEl.appendChild(btn);
  });

  /* === Tool selection === */
  var toolBtns = document.querySelectorAll('[data-tool]');
  toolBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      currentTool = btn.dataset.tool;
      toolBtns.forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      canvas.style.cursor = currentTool === 'eraser' ? 'cell' : 'crosshair';
      announce(currentTool === 'pen' ? 'Pen selected' : 'Eraser selected');
    });
  });

  function selectColor(color, btn) {
    currentColor = color;
    colorsEl.querySelectorAll('.dc-color-btn').forEach(function(b) {
      b.classList.remove('active');
      b.setAttribute('aria-checked', 'false');
    });
    btn.classList.add('active');
    btn.setAttribute('aria-checked', 'true');
    /* Switch to pen when picking a color */
    if (currentTool === 'eraser') {
      currentTool = 'pen';
      toolBtns.forEach(function(b) { b.classList.remove('active'); });
      document.querySelector('[data-tool="pen"]').classList.add('active');
      canvas.style.cursor = 'crosshair';
    }
  }

  function selectSize(size, btn) {
    currentSize = size;
    sizesEl.querySelectorAll('.dc-size-btn').forEach(function(b) {
      b.classList.remove('active');
      b.setAttribute('aria-checked', 'false');
    });
    btn.classList.add('active');
    btn.setAttribute('aria-checked', 'true');
  }

  /* === Canvas drawing === */
  function getPos(e) {
    var rect = canvas.getBoundingClientRect();
    var scaleX = canvas.width / rect.width;
    var scaleY = canvas.height / rect.height;

    if (e.touches) {
      return {
        x: (e.touches[0].clientX - rect.left) * scaleX,
        y: (e.touches[0].clientY - rect.top) * scaleY
      };
    }
    return {
      x: (e.clientX - rect.left) * scaleX,
      y: (e.clientY - rect.top) * scaleY
    };
  }

  function startDraw(e) {
    e.preventDefault();
    isDrawing = true;
    /* Save state for undo before starting a new stroke */
    saveUndo();
    var pos = getPos(e);
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
    ctx.lineWidth = currentTool === 'eraser' ? currentSize * 3 : currentSize;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : currentColor;
    ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
  }

  function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();
    var pos = getPos(e);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
  }

  function stopDraw(e) {
    if (!isDrawing) return;
    isDrawing = false;
    ctx.closePath();
    ctx.globalCompositeOperation = 'source-over';
  }

  /* Mouse events */
  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDraw);
  canvas.addEventListener('mouseleave', stopDraw);

  /* Touch events */
  canvas.addEventListener('touchstart', startDraw, { passive: false });
  canvas.addEventListener('touchmove', draw, { passive: false });
  canvas.addEventListener('touchend', stopDraw);
  canvas.addEventListener('touchcancel', stopDraw);

  /* === Undo === */
  function saveUndo() {
    undoStack.push(canvas.toDataURL());
    if (undoStack.length > MAX_UNDO) undoStack.shift();
  }

  document.getElementById('dc-undo').addEventListener('click', function() {
    if (undoStack.length === 0) {
      announce('Nothing to undo');
      return;
    }
    var imgData = undoStack.pop();
    var img = new Image();
    img.onload = function() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (BG_IMAGE) drawBgImage(); /* Redraw background if set */
      ctx.drawImage(img, 0, 0);
    };
    img.src = imgData;
    announce('Undo applied');
  });

  /* === Clear === */
  document.getElementById('dc-clear').addEventListener('click', function() {
    saveUndo();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (BG_IMAGE) drawBgImage();
    announce('Canvas cleared');
  });

  /* === Save === */
  document.getElementById('dc-save').addEventListener('click', function() {
    var dataUrl = canvas.toDataURL('image/png');
    announce('Drawing saved');

    /* CUSTOMIZE: Store dataUrl for SCORM submission */
    /* Example: SCORM_API.SetValue('cmi.suspend_data', dataUrl); */
    console.log('Drawing saved as data URL (' + Math.round(dataUrl.length / 1024) + 'KB)');
  });

  /* === Background image === */
  function drawBgImage() {
    if (!BG_IMAGE) return;
    var img = new Image();
    img.onload = function() {
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };
    img.src = BG_IMAGE;
  }

  /* === Keyboard shortcuts === */
  document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    if (e.key === 'p' || e.key === 'P') {
      document.querySelector('[data-tool="pen"]').click();
    } else if (e.key === 'e' || e.key === 'E') {
      document.querySelector('[data-tool="eraser"]').click();
    } else if ((e.key === 'z' || e.key === 'Z') && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      document.getElementById('dc-undo').click();
    }
  });

  function announce(msg) {
    var el = document.getElementById('dc-announce');
    if (el) el.textContent = msg;
  }

  /* === Init === */
  if (BG_IMAGE) drawBgImage();
})();
</script>
