<!-- Fill-in-the-Blank Component
     Usage: Copy into lesson HTML for typed-answer questions.
     Requires: base.css (quiz + .quiz-text-input styles)

     The learner types their answer into a text input.
     The engine compares against an array of acceptable answers.

     Customization via data attributes:
     - data-case-sensitive="true"  — Require exact case match
     - data-max-attempts="2"       — Allow retries (default: 1)

     SCORM type: "fill-in"
-->

<fieldset class="quiz-container fill-blank-container"
         role="group"
         aria-labelledby="fill-blank-stem"
         data-question-id="fill-blank-q1"
         data-case-sensitive="false"
         data-max-attempts="1">

  <!-- Question stem -->
  <legend class="question-stem" id="fill-blank-stem">
    What is the chemical symbol for water?
  </legend>

  <!-- Input area -->
  <div class="fill-blank-input-area">
    <label for="fill-blank-input" class="sr-only">Type your answer</label>
    <input type="text"
           id="fill-blank-input"
           class="quiz-text-input"
           placeholder="Type your answer here..."
           autocomplete="off"
           spellcheck="false"
           aria-describedby="fill-blank-hint">
    <p id="fill-blank-hint" class="text-small text-secondary" style="margin-top: var(--space-xs);">
      Type your answer, then press Submit.
    </p>
  </div>

  <!-- Submit button -->
  <div class="quiz-nav">
    <button type="button" class="btn-primary quiz-submit" id="fillBlankSubmitBtn" disabled>
      Submit Answer
    </button>
  </div>

  <!-- Feedback area -->
  <div class="quiz-feedback" id="fillBlankFeedback" role="alert" aria-live="polite" hidden></div>
</fieldset>

<script>
(function() {
  'use strict';

  // ---- Configuration ----
  var container = document.querySelector('[data-question-id="fill-blank-q1"]');
  if (!container) return;

  // Array of acceptable answers (up to 10 variations)
  var acceptableAnswers = ['H2O', 'h2o', 'H\u2082O'];
  var caseSensitive = container.dataset.caseSensitive === 'true';
  var maxAttempts = parseInt(container.dataset.maxAttempts, 10) || 1;
  var attemptsRemaining = maxAttempts;

  var input = container.querySelector('.quiz-text-input');
  var submitBtn = container.querySelector('.quiz-submit');
  var feedbackEl = container.querySelector('.quiz-feedback');

  // ---- Enable submit when input is not empty ----

  input.addEventListener('input', function() {
    submitBtn.disabled = input.value.trim().length === 0;
  });

  // Allow Enter key to submit
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !submitBtn.disabled) {
      e.preventDefault();
      submitBtn.click();
    }
  });

  // ---- Submit Handling ----

  submitBtn.addEventListener('click', function() {
    if (container.classList.contains('quiz-locked')) return;

    var learnerAnswer = input.value.trim();
    if (learnerAnswer.length === 0) return;

    // Evaluate
    var isCorrect = evaluateAnswer(learnerAnswer);
    attemptsRemaining--;

    // Determine feedback type
    var feedbackType;
    if (isCorrect) {
      feedbackType = 'correct';
    } else if (attemptsRemaining > 0) {
      feedbackType = 'tryAgain';
    } else {
      feedbackType = 'incorrect';
    }

    // Show feedback
    showFeedback(feedbackType, learnerAnswer);

    // Lock question if done
    if (feedbackType !== 'tryAgain') {
      lockQuestion(isCorrect);
    } else {
      // Clear input for another attempt
      input.value = '';
      input.focus();
      submitBtn.disabled = true;
    }
  });

  // ---- Evaluation ----

  function evaluateAnswer(learnerAnswer) {
    for (var i = 0; i < acceptableAnswers.length; i++) {
      var acceptable = String(acceptableAnswers[i]).trim();
      if (caseSensitive) {
        if (learnerAnswer === acceptable) return true;
      } else {
        if (learnerAnswer.toLowerCase() === acceptable.toLowerCase()) return true;
      }
    }
    return false;
  }

  // ---- Feedback Display ----

  function showFeedback(type, learnerAnswer) {
    feedbackEl.hidden = false;
    feedbackEl.className = 'quiz-feedback';

    if (type === 'correct') {
      feedbackEl.classList.add('feedback-correct');
      feedbackEl.innerHTML =
        '<span aria-hidden="true">&#10003;</span> ' +
        '<span>That\'s right! <strong>' + escapeHtml(learnerAnswer) +
        '</strong> is correct.</span>';
    } else if (type === 'tryAgain') {
      feedbackEl.classList.add('feedback-tryagain');
      feedbackEl.innerHTML =
        '<span aria-hidden="true">&#8635;</span> ' +
        '<span>Not yet \u2014 give it another try! ' +
        '(' + attemptsRemaining + ' attempt' + (attemptsRemaining > 1 ? 's' : '') +
        ' remaining)</span>';
    } else {
      feedbackEl.classList.add('feedback-incorrect');
      var correctDisplay = acceptableAnswers[0];
      feedbackEl.innerHTML =
        '<span aria-hidden="true">&#10140;</span> ' +
        '<span>Not quite this time. The correct answer is: ' +
        '<strong>' + escapeHtml(correctDisplay) + '</strong></span>';
    }
  }

  // ---- Lock Question ----

  function lockQuestion(isCorrect) {
    container.classList.add('quiz-locked');
    input.disabled = true;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitted';

    if (isCorrect) {
      input.classList.add('input-correct');
    } else {
      input.classList.add('input-incorrect');
    }
  }

  // ---- HTML escape (prevent XSS from learner-typed content) ----

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }

})();
</script>
