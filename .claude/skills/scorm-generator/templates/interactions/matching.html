<!-- Matching / Drag-and-Drop Question Template -->
<div class="question matching-question" data-question-id="{{QUESTION_ID}}" data-type="matching">
  <p class="question-stem">{{QUESTION_STEM}}</p>

  <div class="matching-container">
    <!-- Items to match (draggable) -->
    <div class="matching-items" aria-label="Items to match">
      <h4>Items</h4>
      {{#each ITEMS}}
      <div class="matching-item draggable"
           draggable="true"
           data-item-id="{{id}}"
           role="listitem"
           tabindex="0"
           aria-grabbed="false">
        <span class="drag-handle">⋮⋮</span>
        <span class="item-text">{{text}}</span>
      </div>
      {{/each}}
    </div>

    <!-- Targets (drop zones) -->
    <div class="matching-targets" aria-label="Drop targets">
      <h4>Definitions</h4>
      {{#each TARGETS}}
      <div class="matching-target droppable"
           data-target-id="{{id}}"
           data-correct-match="{{matchTo}}"
           role="listitem"
           aria-dropeffect="move">
        <div class="drop-zone" aria-label="Drop zone for {{text}}">
          <span class="drop-placeholder">Drop here</span>
        </div>
        <span class="target-text">{{text}}</span>
      </div>
      {{/each}}
    </div>
  </div>

  <button class="btn btn-secondary" id="resetMatching_{{QUESTION_ID}}" style="margin-top: var(--space-md);">
    Reset
  </button>

  <div class="feedback" id="feedback_{{QUESTION_ID}}" style="display: none;" aria-live="polite">
    <div class="feedback-correct" style="display: none;">
      <strong>✓ All matches correct!</strong>
      <p>{{FEEDBACK_CORRECT}}</p>
    </div>
    <div class="feedback-incorrect" style="display: none;">
      <strong>✗ Some matches are incorrect.</strong>
      <p>{{FEEDBACK_INCORRECT}}</p>
    </div>
  </div>
</div>

<style>
.matching-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-xl);
  margin: var(--space-lg) 0;
}

@media (max-width: 768px) {
  .matching-container {
    grid-template-columns: 1fr;
  }
}

.matching-items h4,
.matching-targets h4 {
  margin-bottom: var(--space-md);
  color: var(--text-secondary);
  font-size: var(--text-sm);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.matching-item {
  display: flex;
  align-items: center;
  padding: var(--space-sm) var(--space-md);
  background: var(--primary);
  color: white;
  border-radius: var(--radius-md);
  margin-bottom: var(--space-sm);
  cursor: grab;
  transition: all var(--transition-fast);
}

.matching-item:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.matching-item.dragging {
  opacity: 0.5;
  cursor: grabbing;
}

.matching-item.matched {
  display: none;
}

.drag-handle {
  margin-right: var(--space-sm);
  opacity: 0.7;
}

.matching-target {
  display: flex;
  align-items: center;
  gap: var(--space-md);
  margin-bottom: var(--space-sm);
}

.drop-zone {
  min-width: 150px;
  min-height: 44px;
  border: 2px dashed var(--border);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-fast);
}

.drop-zone.drag-over {
  border-color: var(--primary);
  background: var(--info-bg);
}

.drop-zone.has-item {
  border-style: solid;
  border-color: var(--primary);
}

.drop-zone.correct {
  border-color: var(--success);
  background: var(--success-bg);
}

.drop-zone.incorrect {
  border-color: var(--error);
  background: var(--error-bg);
}

.drop-placeholder {
  color: var(--text-muted);
  font-size: var(--text-sm);
}

.dropped-item {
  padding: var(--space-xs) var(--space-sm);
  background: var(--primary);
  color: white;
  border-radius: var(--radius-sm);
  font-size: var(--text-sm);
}

.target-text {
  flex: 1;
  color: var(--text-primary);
}
</style>

<script>
// Drag and Drop functionality
(function() {
  const questionId = '{{QUESTION_ID}}';
  const container = document.querySelector(`[data-question-id="${questionId}"]`);

  if (!container) return;

  const items = container.querySelectorAll('.matching-item');
  const dropZones = container.querySelectorAll('.drop-zone');
  const matches = {};

  items.forEach(item => {
    item.addEventListener('dragstart', handleDragStart);
    item.addEventListener('dragend', handleDragEnd);

    // Keyboard support
    item.addEventListener('keydown', handleKeyboard);
  });

  dropZones.forEach(zone => {
    zone.addEventListener('dragover', handleDragOver);
    zone.addEventListener('dragleave', handleDragLeave);
    zone.addEventListener('drop', handleDrop);
  });

  function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.dataset.itemId);
    e.target.classList.add('dragging');
  }

  function handleDragEnd(e) {
    e.target.classList.remove('dragging');
  }

  function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
  }

  function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
  }

  function handleDrop(e) {
    e.preventDefault();
    const zone = e.currentTarget;
    zone.classList.remove('drag-over');

    const itemId = e.dataTransfer.getData('text/plain');
    const item = container.querySelector(`[data-item-id="${itemId}"]`);
    const targetId = zone.closest('.matching-target').dataset.targetId;

    // Place item in zone
    zone.innerHTML = `<span class="dropped-item">${item.querySelector('.item-text').textContent}</span>`;
    zone.classList.add('has-item');
    item.classList.add('matched');

    matches[targetId] = itemId;
  }

  function handleKeyboard(e) {
    // Space or Enter to select, then arrow keys to move
    // Simplified keyboard support
  }

  // Reset button
  document.getElementById(`resetMatching_${questionId}`).addEventListener('click', () => {
    Object.keys(matches).forEach(key => delete matches[key]);
    items.forEach(item => item.classList.remove('matched'));
    dropZones.forEach(zone => {
      zone.innerHTML = '<span class="drop-placeholder">Drop here</span>';
      zone.classList.remove('has-item', 'correct', 'incorrect');
    });
  });

  // Expose matches for grading
  window[`getMatches_${questionId}`] = () => matches;
})();
</script>
