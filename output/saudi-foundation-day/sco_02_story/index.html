<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>قصة التأسيس — الإمام محمد بن سعود والدرعية</title>
  <link rel="stylesheet" href="../shared/base.css">
  <link rel="stylesheet" href="../shared/theme.css">
  <link rel="stylesheet" href="../shared/player-shell.css">
  <link rel="stylesheet" href="../shared/course-custom.css">
</head>
<body>

<a href="#main-content" class="skip-nav">تخطي إلى المحتوى</a>

<div class="sco-container">

  <!-- ===== TOP NAV BAR ===== -->
  <header class="nav-bar" role="banner">
    <span class="course-title">قصة التأسيس</span>
    <div class="flex items-center gap-md">
      <div class="progress-bar" style="width:120px;">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
      <div class="points-badge" id="pointsBadge" aria-live="polite">
        <span aria-hidden="true">&#11088;</span>
        <span class="points-count" id="pointsCount">0</span>
        <span>نقطة</span>
      </div>
    </div>
  </header>

  <!-- ===== MAIN CONTENT AREA ===== -->
  <main class="sco-content" id="main-content" role="main">

    <!-- ===== SLIDE 1: Story Intro ===== -->
    <div class="slide active" data-slide="0">
      <div class="slide-inner">
        <div class="hero-section saudi-hero text-center">
          <p class="emoji-icon" aria-hidden="true" style="font-size:4rem;">&#127970;</p>
          <h1 style="color:white; font-size:2.2rem;">قصة التأسيس</h1>
          <p style="font-size:1.2rem; color:rgba(255,255,255,0.95); margin-top:var(--space-md);">
            الإمام محمد بن سعود ومدينة الدرعية
          </p>
        </div>
        <div class="callout callout-tip stagger-item" style="animation-delay:300ms; max-width:700px; margin:var(--space-lg) auto 0;">
          <span class="callout-icon" aria-hidden="true">&#128161;</span>
          <div>
            <strong>في هذا الدرس</strong>
            <p style="margin-top:4px;">ستتعرف على قصة الإمام محمد بن سعود وكيف أسس دولة عظيمة في مدينة الدرعية.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== SLIDE 2: Who was Imam Muhammad? (Click-Reveal) ===== -->
    <div class="slide" data-slide="1">
      <div class="slide-inner align-top">
        <h2 style="text-align:center;">&#128081; من هو الإمام محمد بن سعود؟</h2>
        <p class="text-center text-secondary" style="margin-bottom:var(--space-lg);">اضغط على كل قسم لمعرفة المزيد!</p>

        <div style="max-width:700px; margin:0 auto;">
          <!-- Reveal 1 -->
          <div class="card stagger-item" style="margin-bottom:var(--space-md);">
            <div class="reveal-trigger" role="button" tabindex="0" aria-expanded="false"
                 onclick="toggleReveal(this); trackReveal('r1');"
                 onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleReveal(this);trackReveal('r1');}">
              <span style="font-size:1.5rem; margin-left:var(--space-sm);" aria-hidden="true">&#128100;</span>
              <span class="hint-text">نشأته وحياته — اضغط للاكتشاف</span>
            </div>
            <div class="reveal-content">
              <p style="padding:var(--space-md) 0; line-height:2;">
                وُلد الإمام محمد بن سعود في مدينة <strong>الدرعية</strong> ونشأ في بيت حكم وقيادة.
                كان شجاعاً وحكيماً منذ صغره، وتعلم من أسرته معنى المسؤولية وحب الوطن.
                تولى إمارة الدرعية وعمره شاب، وبدأ يحلم ببناء دولة قوية وعادلة.
              </p>
            </div>
          </div>

          <!-- Reveal 2 -->
          <div class="card stagger-item" style="margin-bottom:var(--space-md);">
            <div class="reveal-trigger" role="button" tabindex="0" aria-expanded="false"
                 onclick="toggleReveal(this); trackReveal('r2');"
                 onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleReveal(this);trackReveal('r2');}">
              <span style="font-size:1.5rem; margin-left:var(--space-sm);" aria-hidden="true">&#128172;</span>
              <span class="hint-text">رؤيته للدولة — اضغط للاكتشاف</span>
            </div>
            <div class="reveal-content">
              <p style="padding:var(--space-md) 0; line-height:2;">
                حلم الإمام محمد بن سعود بتوحيد القبائل تحت دولة واحدة تحكمها
                <strong>العدالة والأمان</strong>. أراد أن يعيش الناس في سلام
                وأن تكون الدرعية مركزاً للعلم والتجارة. رؤيته هذه هي التي
                أصبحت أساس المملكة العربية السعودية اليوم!
              </p>
            </div>
          </div>

          <!-- Reveal 3 -->
          <div class="card stagger-item" style="margin-bottom:var(--space-md);">
            <div class="reveal-trigger" role="button" tabindex="0" aria-expanded="false"
                 onclick="toggleReveal(this); trackReveal('r3');"
                 onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleReveal(this);trackReveal('r3');}">
              <span style="font-size:1.5rem; margin-left:var(--space-sm);" aria-hidden="true">&#128170;</span>
              <span class="hint-text">إنجازاته — اضغط للاكتشاف</span>
            </div>
            <div class="reveal-content">
              <p style="padding:var(--space-md) 0; line-height:2;">
                أسس <strong>الدولة السعودية الأولى</strong> عام 1727م،
                وجعل الدرعية عاصمة لها. بنى نظام حكم عادل، وشجع التعليم
                والتجارة. وحّد كثيراً من المناطق تحت راية واحدة، ووضع
                الأساس الذي بُنيت عليه المملكة لاحقاً.
              </p>
            </div>
          </div>
        </div>

        <p class="text-secondary text-center text-small" id="revealProgress" aria-live="polite" style="margin-top:var(--space-md);">
          اكتشفت 0 من 3 أقسام
        </p>
      </div>
    </div>

    <!-- ===== SLIDE 3: Explore Diriyah (Markers) ===== -->
    <div class="slide" data-slide="2">
      <div class="slide-inner">
        <h2 style="text-align:center;">&#127966; استكشف الدرعية</h2>
        <p class="text-center text-secondary" style="margin-bottom:var(--space-lg);">اضغط على النقاط لتتعرف على معالم الدرعية التاريخية!</p>

        <style>
          .markers-container { position:relative; width:100%; max-width:700px; margin:0 auto; border-radius:var(--radius-lg); overflow:hidden; background:var(--color-surface); aspect-ratio:16/9; }
          .markers-bg-placeholder { width:100%; height:100%; background:linear-gradient(135deg, #006C35 0%, #0D9488 40%, #F59E0B 100%); display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,0.3); font-size:3rem; }
          .marker-pin { --marker-size:44px; position:absolute; width:var(--marker-size); height:var(--marker-size); border-radius:50%; background:linear-gradient(135deg, var(--color-primary), var(--color-primary-dark)); color:white; border:3px solid white; box-shadow:var(--shadow-md), 0 0 0 0 rgba(59,130,246,0.4); cursor:pointer; display:flex; align-items:center; justify-content:center; font-family:var(--font-body); font-size:16px; font-weight:700; transition:transform 0.15s ease, box-shadow 0.15s ease; z-index:10; transform:translate(-50%,-50%); animation:markerPulse 2s ease-in-out infinite; }
          .marker-pin:hover { transform:translate(-50%,-50%) scale(1.15); box-shadow:var(--shadow-lg), 0 0 0 8px rgba(59,130,246,0.2); }
          .marker-pin.visited { background:linear-gradient(135deg, var(--color-success), #06B6D4); animation:none; }
          .marker-pin.active { transform:translate(-50%,-50%) scale(1.15); box-shadow:var(--shadow-lg), 0 0 0 8px rgba(59,130,246,0.3); animation:none; }
          @keyframes markerPulse { 0%,100%{box-shadow:var(--shadow-md),0 0 0 0 rgba(59,130,246,0.4);} 50%{box-shadow:var(--shadow-md),0 0 0 8px rgba(59,130,246,0);} }
          .marker-popup { position:absolute; z-index:50; width:260px; max-width:90%; background:var(--color-surface-elevated); border-radius:var(--radius-lg); box-shadow:var(--shadow-lg); border:1px solid var(--color-border); opacity:0; visibility:hidden; transform:translateY(8px) scale(0.95); transition:opacity 0.25s ease, transform 0.25s ease, visibility 0.25s ease; overflow:hidden; }
          .marker-popup.open { opacity:1; visibility:visible; transform:translateY(0) scale(1); }
          .marker-popup-header { background:linear-gradient(135deg, #006C35, #10B981); color:white; padding:var(--space-sm) var(--space-md); display:flex; align-items:center; justify-content:space-between; }
          .marker-popup-header h4 { margin:0; font-size:15px; color:white; font-weight:600; }
          .marker-popup-close { background:rgba(255,255,255,0.2); border:none; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:16px; line-height:1; }
          .marker-popup-close:hover { background:rgba(255,255,255,0.4); }
          .marker-popup-body { padding:var(--space-md); font-size:0.9rem; line-height:1.8; max-height:200px; overflow-y:auto; }
          .markers-progress { text-align:center; margin-top:var(--space-md); font-size:0.9rem; color:var(--color-text-secondary); font-weight:600; }
          .markers-progress .progress-count { color:var(--color-primary); }
        </style>

        <div class="markers-container" role="region" aria-label="خريطة تفاعلية للدرعية">
          <div class="markers-bg-placeholder" aria-hidden="true">&#127970;</div>

          <button class="marker-pin" data-marker-id="m1" data-popup="popup-m1"
                  style="top:30%; left:25%;" aria-label="قصر سلوى — اضغط للاستكشاف"
                  aria-expanded="false" onclick="toggleMarker(this)">1</button>

          <button class="marker-pin" data-marker-id="m2" data-popup="popup-m2"
                  style="top:55%; left:55%;" aria-label="سوق الدرعية — اضغط للاستكشاف"
                  aria-expanded="false" onclick="toggleMarker(this)">2</button>

          <button class="marker-pin" data-marker-id="m3" data-popup="popup-m3"
                  style="top:35%; left:78%;" aria-label="حي الطريف — اضغط للاستكشاف"
                  aria-expanded="false" onclick="toggleMarker(this)">3</button>

          <button class="marker-pin" data-marker-id="m4" data-popup="popup-m4"
                  style="top:70%; left:30%;" aria-label="وادي حنيفة — اضغط للاستكشاف"
                  aria-expanded="false" onclick="toggleMarker(this)">4</button>

          <!-- Popups -->
          <div class="marker-popup" id="popup-m1" role="dialog" aria-labelledby="popup-m1-title">
            <div class="marker-popup-header">
              <h4 id="popup-m1-title">&#127970; قصر سلوى</h4>
              <button class="marker-popup-close" aria-label="إغلاق" onclick="closeAllMarkers()">&times;</button>
            </div>
            <div class="marker-popup-body">
              <p>قصر سلوى كان مقر الحكم الرئيسي للإمام محمد بن سعود. كان أكبر قصور الدرعية ومركز اتخاذ القرارات المهمة.</p>
            </div>
          </div>

          <div class="marker-popup" id="popup-m2" role="dialog" aria-labelledby="popup-m2-title">
            <div class="marker-popup-header">
              <h4 id="popup-m2-title">&#128722; سوق الدرعية</h4>
              <button class="marker-popup-close" aria-label="إغلاق" onclick="closeAllMarkers()">&times;</button>
            </div>
            <div class="marker-popup-body">
              <p>كان السوق مركزاً تجارياً نشطاً يجتمع فيه التجار من أنحاء الجزيرة العربية. كان يُباع فيه التمر والبخور والأقمشة.</p>
            </div>
          </div>

          <div class="marker-popup" id="popup-m3" role="dialog" aria-labelledby="popup-m3-title">
            <div class="marker-popup-header">
              <h4 id="popup-m3-title">&#127967; حي الطريف</h4>
              <button class="marker-popup-close" aria-label="إغلاق" onclick="closeAllMarkers()">&times;</button>
            </div>
            <div class="marker-popup-body">
              <p>حي الطريف هو الحي التاريخي الذي يضم قصر سلوى وعدة مبانٍ تاريخية. تم تسجيله في قائمة التراث العالمي لليونسكو عام 2010.</p>
            </div>
          </div>

          <div class="marker-popup" id="popup-m4" role="dialog" aria-labelledby="popup-m4-title">
            <div class="marker-popup-header">
              <h4 id="popup-m4-title">&#128167; وادي حنيفة</h4>
              <button class="marker-popup-close" aria-label="إغلاق" onclick="closeAllMarkers()">&times;</button>
            </div>
            <div class="marker-popup-body">
              <p>وادي حنيفة كان شريان الحياة للدرعية، حيث كان يوفر المياه للزراعة والشرب. كانت المزارع على ضفافه تنتج التمور والحبوب.</p>
            </div>
          </div>
        </div>

        <div class="markers-progress" aria-live="polite">
          <span class="progress-count" id="markers-visited-count">0</span> من
          <span id="markers-total-count">4</span> معالم تم استكشافها
        </div>
      </div>
    </div>

    <!-- ===== SLIDE 4: Key Values ===== -->
    <div class="slide" data-slide="3">
      <div class="slide-inner">
        <h2 style="text-align:center;">&#127775; قيم التأسيس</h2>
        <p class="text-center text-secondary" style="margin-bottom:var(--space-lg);">القيم التي قامت عليها الدولة السعودية الأولى</p>

        <div class="fun-grid" style="max-width:700px; margin:0 auto;">
          <div class="card text-center stagger-item">
            <p class="emoji-icon" aria-hidden="true">&#9878;&#65039;</p>
            <h3>العدل</h3>
            <p class="text-secondary text-small">الحكم بالعدل بين الناس وإعطاء كل ذي حق حقه.</p>
          </div>
          <div class="card text-center stagger-item">
            <p class="emoji-icon" aria-hidden="true">&#129309;</p>
            <h3>الوحدة</h3>
            <p class="text-secondary text-small">توحيد القبائل والمناطق تحت دولة واحدة قوية.</p>
          </div>
          <div class="card text-center stagger-item">
            <p class="emoji-icon" aria-hidden="true">&#128218;</p>
            <h3>العلم</h3>
            <p class="text-secondary text-small">تشجيع التعليم ونشر المعرفة بين الناس.</p>
          </div>
          <div class="card text-center stagger-item">
            <p class="emoji-icon" aria-hidden="true">&#128170;</p>
            <h3>الشجاعة</h3>
            <p class="text-secondary text-small">الدفاع عن الوطن وحماية الناس بقوة وإقدام.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== SLIDE 5: Lesson Complete ===== -->
    <div class="slide" data-slide="4">
      <div class="slide-inner">
        <div class="completion-message">
          <p style="font-size:4rem;" aria-hidden="true">&#127942;</p>
          <h2>رائع! أكملت درس قصة التأسيس</h2>
          <p style="font-size:1.1rem; color:var(--color-text-secondary); margin:var(--space-md) 0 var(--space-lg);">
            تعرفت على الإمام محمد بن سعود واستكشفت معالم الدرعية التاريخية!
          </p>
          <div class="badge-earned">
            <span aria-hidden="true">&#128081;</span>
            <span>حصلت على وسام: مؤرخ الدرعية</span>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- ===== BOTTOM NAVIGATION ===== -->
  <nav class="sco-nav" role="navigation" aria-label="تنقل الدرس">
    <button class="btn-prev" id="prevBtn" disabled data-next-text="السابق">السابق</button>
    <span class="page-indicator" id="pageIndicator" aria-live="polite">1 / 5</span>
    <button class="btn-next" id="nextBtn" data-next-text="التالي" data-complete-text="إنهاء الدرس">التالي</button>
  </nav>

</div>

<!-- ===== SCRIPTS ===== -->
<script src="../shared/scorm-api.js"></script>
<script src="../shared/engine/slide-controller.js"></script>

<script>
/* ============================================================
   SCO 02: Story — قصة التأسيس
   ============================================================ */

/* --- SCORM --- */
var scorm = new SCORMWrapper();
scorm.initialize();

/* --- Points --- */
var totalPoints = 0;
function addPoints(amount) {
  totalPoints += amount;
  var el = document.getElementById('pointsCount');
  if (el) {
    el.textContent = totalPoints;
    var badge = document.getElementById('pointsBadge');
    if (badge) { badge.classList.add('glow'); setTimeout(function(){ badge.classList.remove('glow'); }, 600); }
  }
}

/* --- Click-to-Reveal --- */
function toggleReveal(trigger) {
  var content = trigger.nextElementSibling;
  var isVisible = content.classList.contains('visible');
  if (isVisible) {
    content.classList.remove('visible');
    trigger.setAttribute('aria-expanded', 'false');
    trigger.querySelector('.hint-text').textContent = trigger.querySelector('.hint-text').textContent.replace('اضغط للإخفاء', 'اضغط للاكتشاف');
  } else {
    content.classList.add('visible');
    trigger.setAttribute('aria-expanded', 'true');
    trigger.querySelector('.hint-text').textContent = trigger.querySelector('.hint-text').textContent.replace('اضغط للاكتشاف', 'اضغط للإخفاء');
  }
}

var revealed = {};
function trackReveal(id) {
  if (!revealed[id]) {
    revealed[id] = true;
    addPoints(5);
    var count = Object.keys(revealed).length;
    var el = document.getElementById('revealProgress');
    if (el) el.textContent = 'اكتشفت ' + count + ' من 3 أقسام';
    if (count === 3) {
      addPoints(10);
      if (el) el.innerHTML = '&#127881; اكتشفت جميع الأقسام! +10 نقاط إضافية';
    }
  }
}

/* --- Markers Component --- */
var markersVisited = {};

function toggleMarker(btn) {
  var popupId = btn.getAttribute('data-popup');
  var popup = document.getElementById(popupId);
  var markerId = btn.getAttribute('data-marker-id');
  var isOpen = popup.classList.contains('open');
  closeAllMarkers();
  if (isOpen) return;
  popup.classList.add('open');
  btn.classList.add('active');
  btn.setAttribute('aria-expanded', 'true');
  if (!markersVisited[markerId]) {
    markersVisited[markerId] = true;
    btn.classList.add('visited');
    addPoints(5);
    updateMarkersProgress();
  }
  positionPopup(btn, popup);
  var closeBtn = popup.querySelector('.marker-popup-close');
  if (closeBtn) closeBtn.focus();
}

function closeAllMarkers() {
  document.querySelectorAll('.marker-popup.open').forEach(function(p){ p.classList.remove('open'); });
  document.querySelectorAll('.marker-pin.active').forEach(function(pin){ pin.classList.remove('active'); pin.setAttribute('aria-expanded','false'); });
}

function positionPopup(markerBtn, popup) {
  var container = markerBtn.closest('.markers-container');
  var cRect = container.getBoundingClientRect();
  var mRect = markerBtn.getBoundingClientRect();
  var cx = mRect.left - cRect.left + mRect.width/2;
  var cy = mRect.top - cRect.top + mRect.height/2;
  var px = cx + 20;
  var py = cy + 20;
  if (px + 260 > cRect.width) px = cx - 280;
  if (px < 8) px = 8;
  if (py + 200 > cRect.height) py = cy - 220;
  if (py < 8) py = 8;
  popup.style.left = px + 'px';
  popup.style.top = py + 'px';
}

function updateMarkersProgress() {
  var count = Object.keys(markersVisited).length;
  var el = document.getElementById('markers-visited-count');
  if (el) el.textContent = count;
  if (count === 4) addPoints(10);
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') { var open = document.querySelector('.marker-popup.open'); if (open) { var active = document.querySelector('.marker-pin.active'); closeAllMarkers(); if (active) active.focus(); } }
});
document.addEventListener('click', function(e) {
  if (!e.target.closest('.marker-pin') && !e.target.closest('.marker-popup')) closeAllMarkers();
});

/* --- Confetti --- */
function launchConfetti() {
  var colors = ['#3B82F6','#10B981','#F59E0B','#EC4899','#006C35','#8B5CF6'];
  for (var i=0; i<40; i++) {
    var p = document.createElement('div');
    p.className = 'confetti-piece';
    p.style.left = Math.random()*100+'vw';
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    p.style.width = (Math.random()*8+6)+'px';
    p.style.height = (Math.random()*8+6)+'px';
    p.style.borderRadius = Math.random()>0.5?'50%':'2px';
    p.style.animation = 'confetti-fall '+(Math.random()*2+1.5)+'s ease-out forwards';
    p.style.animationDelay = (Math.random()*0.5)+'s';
    document.body.appendChild(p);
    (function(el){ setTimeout(function(){ if(el.parentNode) el.parentNode.removeChild(el); }, 4000); })(p);
  }
}

/* --- Slide Controller --- */
var controller = new SlideController({
  onSlideChange: function(index, total) { addPoints(5); },
  onComplete: function() {
    addPoints(20);
    launchConfetti();
    if (scorm && scorm.initialized) {
      scorm.setLessonStatus('completed');
      scorm.setScore(100, 100, 0);
      scorm.commit();
    }
  }
});

/* --- Session Timing --- */
var sessionStart = new Date();
window.addEventListener('beforeunload', function() {
  if (scorm && scorm.initialized) {
    var elapsed = Math.floor((new Date() - sessionStart) / 1000);
    scorm.setSessionTime(elapsed);
    scorm.commit();
    scorm.terminate();
  }
});
</script>

</body>
</html>
