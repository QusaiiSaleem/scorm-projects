<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>اختبر معلوماتك — يوم التأسيس السعودي</title>
  <link rel="stylesheet" href="../shared/base.css">
  <link rel="stylesheet" href="../shared/theme.css">
  <link rel="stylesheet" href="../shared/player-shell.css">
  <link rel="stylesheet" href="../shared/course-custom.css">
</head>
<body>

<a href="#main-content" class="skip-nav">تخطي إلى المحتوى</a>

<div class="sco-container">

  <!-- ===== TOP NAV BAR ===== -->
  <header class="nav-bar" role="banner">
    <span class="course-title">اختبر معلوماتك!</span>
    <div class="flex items-center gap-md">
      <div class="progress-bar" style="width:120px;">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
      <div class="points-badge" id="pointsBadge" aria-live="polite">
        <span aria-hidden="true">&#11088;</span>
        <span class="points-count" id="pointsCount">0</span>
        <span>نقطة</span>
      </div>
    </div>
  </header>

  <!-- ===== MAIN CONTENT AREA ===== -->
  <main class="sco-content" id="main-content" role="main">

    <!-- ===== SLIDE 1: Quiz Intro ===== -->
    <div class="slide active" data-slide="0">
      <div class="slide-inner">
        <div class="hero-section text-center" style="background:linear-gradient(135deg, #8B5CF6, #3B82F6, #10B981);">
          <p style="font-size:4rem;" aria-hidden="true">&#128221;</p>
          <h1 style="color:white; font-size:2.2rem;">اختبر معلوماتك!</h1>
          <p style="font-size:1.2rem; color:rgba(255,255,255,0.95); margin-top:var(--space-md);">
            هل أنت جاهز لاختبار ما تعلمته عن يوم التأسيس؟
          </p>
        </div>
        <div class="card text-center stagger-item" style="max-width:500px; margin:var(--space-lg) auto;">
          <p class="emoji-icon" aria-hidden="true">&#127919;</p>
          <h3>6 أسئلة متنوعة</h3>
          <p class="text-secondary" style="margin-bottom:var(--space-md);">
            اختيار من متعدد + صح وخطأ + ترتيب
          </p>
          <p class="text-small text-secondary">
            تحتاج <strong>4 إجابات صحيحة من 6</strong> للنجاح &#128170;
          </p>
        </div>
      </div>
    </div>

    <!-- ===== SLIDE 2: Q1 — Multiple Choice ===== -->
    <div class="slide" data-slide="1">
      <div class="slide-inner">
        <div class="quiz-container">
          <div class="quiz-header">
            <p class="quiz-progress">السؤال 1 من 6</p>
          </div>
          <p class="question-stem">متى نحتفل بيوم التأسيس السعودي؟</p>
          <div class="quiz-options" id="q1-options">
            <button class="btn-quiz-option" data-correct="false" onclick="checkAnswer(this, 'q1')">23 سبتمبر</button>
            <button class="btn-quiz-option" data-correct="true" onclick="checkAnswer(this, 'q1')">22 فبراير</button>
            <button class="btn-quiz-option" data-correct="false" onclick="checkAnswer(this, 'q1')">1 يناير</button>
            <button class="btn-quiz-option" data-correct="false" onclick="checkAnswer(this, 'q1')">12 ديسمبر</button>
          </div>
          <div id="q1-feedback" style="margin-top:var(--space-md);"></div>
        </div>
      </div>
    </div>

    <!-- ===== SLIDE 3: Q2 — Multiple Choice ===== -->
    <div class="slide" data-slide="2">
      <div class="slide-inner">
        <div class="quiz-container">
          <div class="quiz-header">
            <p class="quiz-progress">السؤال 2 من 6</p>
          </div>
          <p class="question-stem">من هو مؤسس الدولة السعودية الأولى؟</p>
          <div class="quiz-options" id="q2-options">
            <button class="btn-quiz-option" data-correct="false" onclick="checkAnswer(this, 'q2')">الملك عبدالعزيز بن عبدالرحمن</button>
            <button class="btn-quiz-option" data-correct="false" onclick="checkAnswer(this, 'q2')">الإمام تركي بن عبدالله</button>
            <button class="btn-quiz-option" data-correct="true" onclick="checkAnswer(this, 'q2')">الإمام محمد بن سعود</button>
            <button class="btn-quiz-option" data-correct="false" onclick="checkAnswer(this, 'q2')">الملك فيصل بن عبدالعزيز</button>
          </div>
          <div id="q2-feedback" style="margin-top:var(--space-md);"></div>
        </div>
      </div>
    </div>

    <!-- ===== SLIDE 4: Q3 — True/False ===== -->
    <div class="slide" data-slide="3">
      <div class="slide-inner">
        <div class="quiz-container">
          <div class="quiz-header">
            <p class="quiz-progress">السؤال 3 من 6</p>
          </div>
          <p class="question-stem">صح أم خطأ: الدرعية كانت عاصمة الدولة السعودية الأولى.</p>
          <div class="quiz-options" id="q3-options" style="max-width:400px; margin:0 auto;">
            <button class="btn-quiz-option" data-correct="true" onclick="checkAnswer(this, 'q3')" style="text-align:center;">
              &#9989; صح
            </button>
            <button class="btn-quiz-option" data-correct="false" onclick="checkAnswer(this, 'q3')" style="text-align:center;">
              &#10060; خطأ
            </button>
          </div>
          <div id="q3-feedback" style="margin-top:var(--space-md);"></div>
        </div>
      </div>
    </div>

    <!-- ===== SLIDE 5: Q4 — Multiple Choice ===== -->
    <div class="slide" data-slide="4">
      <div class="slide-inner">
        <div class="quiz-container">
          <div class="quiz-header">
            <p class="quiz-progress">السؤال 4 من 6</p>
          </div>
          <p class="question-stem">ماذا يرمز السيفان المتقاطعان في شعار المملكة؟</p>
          <div class="quiz-options" id="q4-options">
            <button class="btn-quiz-option" data-correct="false" onclick="checkAnswer(this, 'q4')">الزراعة والتجارة</button>
            <button class="btn-quiz-option" data-correct="true" onclick="checkAnswer(this, 'q4')">القوة والمنعة</button>
            <button class="btn-quiz-option" data-correct="false" onclick="checkAnswer(this, 'q4')">العلم والمعرفة</button>
            <button class="btn-quiz-option" data-correct="false" onclick="checkAnswer(this, 'q4')">السفر والاستكشاف</button>
          </div>
          <div id="q4-feedback" style="margin-top:var(--space-md);"></div>
        </div>
      </div>
    </div>

    <!-- ===== SLIDE 6: Q5 — True/False ===== -->
    <div class="slide" data-slide="5">
      <div class="slide-inner">
        <div class="quiz-container">
          <div class="quiz-header">
            <p class="quiz-progress">السؤال 5 من 6</p>
          </div>
          <p class="question-stem">صح أم خطأ: تم توحيد المملكة العربية السعودية عام 1902م.</p>
          <div class="quiz-options" id="q5-options" style="max-width:400px; margin:0 auto;">
            <button class="btn-quiz-option" data-correct="false" onclick="checkAnswer(this, 'q5')" style="text-align:center;">
              &#9989; صح
            </button>
            <button class="btn-quiz-option" data-correct="true" onclick="checkAnswer(this, 'q5')" style="text-align:center;">
              &#10060; خطأ
            </button>
          </div>
          <div id="q5-feedback" style="margin-top:var(--space-md);"></div>
        </div>
      </div>
    </div>

    <!-- ===== SLIDE 7: Q6 — Order / Sequence ===== -->
    <div class="slide" data-slide="6">
      <div class="slide-inner align-top">
        <div class="quiz-container">
          <div class="quiz-header">
            <p class="quiz-progress">السؤال 6 من 6</p>
          </div>
          <p class="question-stem">رتب الأحداث التالية من الأقدم إلى الأحدث:</p>
          <p class="text-secondary text-small" style="margin-bottom:var(--space-md); text-align:center;">اسحب الأحداث لترتيبها بالتسلسل الصحيح</p>

          <div id="sortable-list" style="max-width:600px; margin:0 auto;">
            <div class="sort-item card" draggable="true" data-order="2" tabindex="0"
                 style="margin-bottom:var(--space-sm); cursor:grab; padding:var(--space-md) var(--space-lg); display:flex; align-items:center; gap:var(--space-md);">
              <span class="sort-handle" aria-hidden="true" style="color:var(--color-text-secondary); font-size:1.2rem;">&#9776;</span>
              <span>استرداد الرياض</span>
            </div>
            <div class="sort-item card" draggable="true" data-order="3" tabindex="0"
                 style="margin-bottom:var(--space-sm); cursor:grab; padding:var(--space-md) var(--space-lg); display:flex; align-items:center; gap:var(--space-md);">
              <span class="sort-handle" aria-hidden="true" style="color:var(--color-text-secondary); font-size:1.2rem;">&#9776;</span>
              <span>توحيد المملكة</span>
            </div>
            <div class="sort-item card" draggable="true" data-order="1" tabindex="0"
                 style="margin-bottom:var(--space-sm); cursor:grab; padding:var(--space-md) var(--space-lg); display:flex; align-items:center; gap:var(--space-md);">
              <span class="sort-handle" aria-hidden="true" style="color:var(--color-text-secondary); font-size:1.2rem;">&#9776;</span>
              <span>تأسيس الدولة السعودية الأولى</span>
            </div>
            <div class="sort-item card" draggable="true" data-order="4" tabindex="0"
                 style="margin-bottom:var(--space-sm); cursor:grab; padding:var(--space-md) var(--space-lg); display:flex; align-items:center; gap:var(--space-md);">
              <span class="sort-handle" aria-hidden="true" style="color:var(--color-text-secondary); font-size:1.2rem;">&#9776;</span>
              <span>أول احتفال بيوم التأسيس</span>
            </div>
          </div>

          <div style="text-align:center; margin-top:var(--space-lg);">
            <button class="btn-primary" id="checkSortBtn" onclick="checkSort()">&#128270; تحقق من الترتيب</button>
          </div>
          <div id="q6-feedback" style="margin-top:var(--space-md);"></div>
        </div>
      </div>
    </div>

    <!-- ===== SLIDE 8: Score & Results ===== -->
    <div class="slide" data-slide="7">
      <div class="slide-inner">
        <div class="quiz-score" id="scoreSection">
          <!-- Populated by JavaScript -->
        </div>
      </div>
    </div>

  </main>

  <!-- ===== BOTTOM NAVIGATION ===== -->
  <nav class="sco-nav" role="navigation" aria-label="تنقل الاختبار">
    <button class="btn-prev" id="prevBtn" disabled data-next-text="السابق">السابق</button>
    <span class="page-indicator" id="pageIndicator" aria-live="polite">1 / 8</span>
    <button class="btn-next" id="nextBtn" data-next-text="التالي" data-complete-text="عرض النتيجة">التالي</button>
  </nav>

</div>

<!-- ===== SCRIPTS ===== -->
<script src="../shared/scorm-api.js"></script>
<script src="../shared/engine/slide-controller.js"></script>

<script>
/* ============================================================
   SCO 04: Quiz — اختبر معلوماتك
   ============================================================ */

/* --- SCORM --- */
var scorm = new SCORMWrapper();
scorm.initialize();

/* --- Points --- */
var totalPoints = 0;
function addPoints(amount) {
  totalPoints += amount;
  var el = document.getElementById('pointsCount');
  if (el) {
    el.textContent = totalPoints;
    var badge = document.getElementById('pointsBadge');
    if (badge) { badge.classList.add('glow'); setTimeout(function(){ badge.classList.remove('glow'); }, 600); }
  }
}

/* --- Quiz State --- */
var score = 0;
var totalQuestions = 6;
var answeredQuestions = {};

/* --- Multiple Choice / True-False Answer Check --- */
function checkAnswer(btn, qId) {
  if (answeredQuestions[qId]) return; /* Already answered */
  answeredQuestions[qId] = true;

  var container = document.getElementById(qId + '-options');
  var feedbackEl = document.getElementById(qId + '-feedback');
  var isCorrect = btn.getAttribute('data-correct') === 'true';
  var options = container.querySelectorAll('.btn-quiz-option');

  /* Disable all options */
  options.forEach(function(opt) {
    opt.disabled = true;
    if (opt.getAttribute('data-correct') === 'true') {
      opt.classList.add('correct');
    }
  });

  if (isCorrect) {
    btn.classList.add('correct');
    score++;
    addPoints(15);
    feedbackEl.innerHTML = '<div class="feedback-correct"><span style="font-size:1.3rem;" aria-hidden="true">&#127881;</span><div><strong>أحسنت! إجابة صحيحة!</strong><p class="text-small" style="margin-top:4px;">استمر بهذا الأداء الرائع!</p></div></div>';
  } else {
    btn.classList.add('incorrect');
    addPoints(3); /* Participation points */
    feedbackEl.innerHTML = '<div class="feedback-incorrect"><span style="font-size:1.3rem;" aria-hidden="true">&#128170;</span><div><strong>ليس بعد — لا بأس!</strong><p class="text-small" style="margin-top:4px;">التعلم رحلة، والإجابة الصحيحة محددة باللون الأخضر. تذكرها للمرة القادمة!</p></div></div>';
  }

  /* Report to SCORM */
  reportInteraction(qId, btn.textContent.trim(), isCorrect);
}

/* --- Sequence Sort (Q6) --- */
var sortDragItem = null;

/* Make sort items draggable */
document.querySelectorAll('#sortable-list .sort-item').forEach(function(item) {
  item.addEventListener('dragstart', function(e) {
    sortDragItem = this;
    this.style.opacity = '0.4';
    e.dataTransfer.effectAllowed = 'move';
  });

  item.addEventListener('dragend', function() {
    this.style.opacity = '1';
    sortDragItem = null;
    document.querySelectorAll('#sortable-list .sort-item').forEach(function(s) {
      s.style.borderTop = '';
    });
  });

  item.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    this.style.borderTop = '3px solid var(--color-primary)';
  });

  item.addEventListener('dragleave', function() {
    this.style.borderTop = '';
  });

  item.addEventListener('drop', function(e) {
    e.preventDefault();
    this.style.borderTop = '';
    if (sortDragItem && sortDragItem !== this) {
      var list = document.getElementById('sortable-list');
      var items = Array.from(list.children);
      var dragIdx = items.indexOf(sortDragItem);
      var dropIdx = items.indexOf(this);
      if (dragIdx < dropIdx) {
        list.insertBefore(sortDragItem, this.nextSibling);
      } else {
        list.insertBefore(sortDragItem, this);
      }
    }
  });

  /* Touch support for sort */
  var touchStartY = 0;
  item.addEventListener('touchstart', function(e) {
    touchStartY = e.touches[0].clientY;
    sortDragItem = this;
    this.style.opacity = '0.6';
  }, {passive: true});

  item.addEventListener('touchmove', function(e) {
    e.preventDefault();
    var touch = e.touches[0];
    var list = document.getElementById('sortable-list');
    var items = Array.from(list.querySelectorAll('.sort-item'));
    items.forEach(function(s) {
      var r = s.getBoundingClientRect();
      if (touch.clientY > r.top && touch.clientY < r.bottom && s !== sortDragItem) {
        s.style.borderTop = '3px solid var(--color-primary)';
      } else {
        s.style.borderTop = '';
      }
    });
  });

  item.addEventListener('touchend', function(e) {
    this.style.opacity = '1';
    var touch = e.changedTouches[0];
    var list = document.getElementById('sortable-list');
    var items = Array.from(list.querySelectorAll('.sort-item'));
    items.forEach(function(s) { s.style.borderTop = ''; });
    items.forEach(function(s) {
      if (s !== sortDragItem) {
        var r = s.getBoundingClientRect();
        if (touch.clientY > r.top && touch.clientY < r.bottom) {
          list.insertBefore(sortDragItem, s);
        }
      }
    });
    sortDragItem = null;
  });

  /* Keyboard sort: Arrow Up/Down to reorder */
  item.addEventListener('keydown', function(e) {
    var list = document.getElementById('sortable-list');
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      e.stopPropagation();
      var prev = this.previousElementSibling;
      if (prev) {
        list.insertBefore(this, prev);
        this.focus();
      }
    }
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      e.stopPropagation();
      var next = this.nextElementSibling;
      if (next) {
        list.insertBefore(this, next.nextSibling);
        this.focus();
      }
    }
  });
});

function checkSort() {
  if (answeredQuestions['q6']) return;
  answeredQuestions['q6'] = true;

  var list = document.getElementById('sortable-list');
  var items = list.querySelectorAll('.sort-item');
  var isCorrect = true;

  items.forEach(function(item, index) {
    var expectedOrder = index + 1;
    var actualOrder = parseInt(item.getAttribute('data-order'));
    if (actualOrder !== expectedOrder) {
      isCorrect = false;
      item.style.borderColor = 'var(--color-growth)';
      item.style.background = 'var(--color-growth-bg)';
    } else {
      item.style.borderColor = 'var(--color-success)';
      item.style.background = 'var(--color-success-bg)';
    }
    item.setAttribute('draggable', 'false');
    item.style.cursor = 'default';
  });

  var feedbackEl = document.getElementById('q6-feedback');
  var btn = document.getElementById('checkSortBtn');
  btn.disabled = true;
  btn.style.opacity = '0.5';

  if (isCorrect) {
    score++;
    addPoints(20);
    feedbackEl.innerHTML = '<div class="feedback-correct"><span style="font-size:1.3rem;" aria-hidden="true">&#127881;</span><div><strong>رائع! الترتيب صحيح!</strong><p class="text-small" style="margin-top:4px;">أنت تعرف تاريخ المملكة بشكل ممتاز!</p></div></div>';
  } else {
    addPoints(5);
    feedbackEl.innerHTML = '<div class="feedback-incorrect"><span style="font-size:1.3rem;" aria-hidden="true">&#128170;</span><div><strong>ليس بعد — الترتيب الصحيح هو:</strong><p class="text-small" style="margin-top:4px;">1. تأسيس الدولة الأولى (1727م) ← 2. استرداد الرياض (1902م) ← 3. توحيد المملكة (1932م) ← 4. أول احتفال بيوم التأسيس (2022م)</p></div></div>';
  }

  reportInteraction('q6', 'sequence', isCorrect);
}

/* --- SCORM Interaction Reporting --- */
var interactionCount = 0;
function reportInteraction(qId, response, correct) {
  if (scorm && scorm.api) {
    try {
      var n = interactionCount;
      if (scorm.version === '1.2') {
        scorm.api.LMSSetValue('cmi.interactions.' + n + '.id', qId);
        scorm.api.LMSSetValue('cmi.interactions.' + n + '.type', qId === 'q6' ? 'sequencing' : 'choice');
        scorm.api.LMSSetValue('cmi.interactions.' + n + '.result', correct ? 'correct' : 'wrong');
        scorm.api.LMSSetValue('cmi.interactions.' + n + '.student_response', response);
      }
      interactionCount++;
      scorm.commit();
    } catch(e) { /* Standalone mode */ }
  }
}

/* --- Show Final Score --- */
function showScore() {
  var pct = Math.round((score / totalQuestions) * 100);
  var passed = score >= 4;
  var section = document.getElementById('scoreSection');

  section.className = 'quiz-score ' + (passed ? 'pass' : 'fail');
  section.innerHTML =
    '<div class="score-circle">' + pct + '%</div>' +
    '<h2 style="margin:var(--space-md) 0;">' +
      (passed ? '&#127881; مبارك! نجحت في الاختبار!' : '&#128170; لا بأس — يمكنك المحاولة مرة أخرى!') +
    '</h2>' +
    '<p style="font-size:1.1rem; color:var(--color-text-secondary);">' +
      'أجبت على <strong>' + score + '</strong> من <strong>' + totalQuestions + '</strong> أسئلة بشكل صحيح' +
    '</p>' +
    '<p style="margin-top:var(--space-md); font-size:1.1rem;">' +
      '&#11088; مجموع النقاط: <strong>' + totalPoints + '</strong> نقطة' +
    '</p>' +
    (passed ?
      '<div class="badge-earned" style="margin-top:var(--space-lg);"><span aria-hidden="true">&#127942;</span><span>حصلت على وسام: بطل يوم التأسيس!</span></div>' :
      '<button class="btn-primary" style="margin-top:var(--space-lg);" onclick="location.reload();">&#128260; أعد المحاولة</button>'
    );

  /* SCORM: Report final score */
  if (scorm && scorm.initialized) {
    scorm.setScore(pct, 100, 0);
    scorm.setLessonStatus(passed ? 'passed' : 'failed');
    scorm.commit();
  }

  /* Confetti on pass */
  if (passed) launchConfetti();
}

/* --- Confetti --- */
function launchConfetti() {
  var colors = ['#3B82F6','#10B981','#F59E0B','#EC4899','#006C35','#8B5CF6'];
  for (var i=0; i<50; i++) {
    var p = document.createElement('div');
    p.className = 'confetti-piece';
    p.style.left = Math.random()*100+'vw';
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    p.style.width = (Math.random()*8+6)+'px';
    p.style.height = (Math.random()*8+6)+'px';
    p.style.borderRadius = Math.random()>0.5?'50%':'2px';
    p.style.animation = 'confetti-fall '+(Math.random()*2+1.5)+'s ease-out forwards';
    p.style.animationDelay = (Math.random()*0.5)+'s';
    document.body.appendChild(p);
    (function(el){ setTimeout(function(){ if(el.parentNode) el.parentNode.removeChild(el); }, 4000); })(p);
  }
}

/* --- Slide Controller --- */
var controller = new SlideController({
  onSlideChange: function(index, total) {
    /* Update progress */
    var pFill = document.getElementById('progressFill');
    if (pFill) pFill.style.width = ((index + 1) / total * 100) + '%';
  },
  onComplete: function() {
    /* Show score when reaching last slide */
    showScore();
  }
});

/* --- Session Timing --- */
var sessionStart = new Date();
window.addEventListener('beforeunload', function() {
  if (scorm && scorm.initialized) {
    var elapsed = Math.floor((new Date() - sessionStart) / 1000);
    scorm.setSessionTime(elapsed);
    scorm.commit();
    scorm.terminate();
  }
});
</script>

</body>
</html>
