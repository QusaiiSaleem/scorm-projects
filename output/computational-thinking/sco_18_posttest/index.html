<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>الاختبار البعدي | التفكير الحاسوبي</title>

  <!-- Layered CSS: base -> theme -> decorations -->
  <link rel="stylesheet" href="../shared/base.css">
  <link rel="stylesheet" href="../shared/theme.css">
  <link rel="stylesheet" href="../shared/decorations.css">

  <style>
    /* ==========================================================================
       SCO 18 — Post-test Custom Styles
       ========================================================================== */

    .quiz-viewport {
      width: 100%;
      max-width: var(--max-content-width, 900px);
      margin: 0 auto;
      min-height: calc(100vh - 140px);
      display: flex;
      flex-direction: column;
    }

    /* -- Question slide (one at a time) -- */
    .question-slide {
      display: none;
      flex: 1;
      flex-direction: column;
      animation: qSlideIn 0.25s var(--ease-snappy, ease) forwards;
    }
    .question-slide.active { display: flex; }

    @keyframes qSlideIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* -- Question header -- */
    .q-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md, 16px);
      flex-wrap: wrap;
      gap: var(--space-sm, 8px);
    }

    .q-number {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--color-text-muted, #64748B);
    }

    .q-type-badge {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      padding: 3px 10px;
      border-radius: var(--radius-pill, 9999px);
      border: 1px solid var(--color-border-highlight, #334155);
      color: var(--color-text-secondary, #94A3B8);
    }

    .q-difficulty {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: var(--radius-sm, 4px);
    }
    .q-difficulty.easy { background: rgba(52, 211, 153, 0.12); color: var(--color-success); }
    .q-difficulty.medium { background: rgba(251, 191, 36, 0.12); color: var(--color-warning); }
    .q-difficulty.hard { background: rgba(251, 113, 133, 0.12); color: var(--color-error); }

    /* -- Question stem -- */
    .q-stem {
      font-size: 1.05rem;
      line-height: 1.8;
      color: var(--color-text, #E2E8F0);
      margin-bottom: var(--space-lg, 24px);
    }

    .q-stem pre {
      background: var(--color-background, #0B1120);
      border: 1px solid var(--color-border, #1E293B);
      border-radius: var(--radius-md, 6px);
      padding: var(--space-md, 16px);
      font-family: var(--font-mono);
      font-size: 0.85rem;
      line-height: 1.7;
      overflow-x: auto;
      direction: ltr;
      text-align: left;
      margin-top: var(--space-md, 16px);
      color: var(--color-text, #E2E8F0);
      white-space: pre;
    }

    /* -- MCQ Options -- */
    .mcq-options {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm, 8px);
    }

    .mcq-option {
      display: flex;
      align-items: flex-start;
      gap: var(--space-md, 16px);
      padding: var(--space-md, 16px) var(--space-lg, 24px);
      background: var(--color-surface, #141B2D);
      border: 1px solid var(--color-border, #1E293B);
      border-radius: var(--radius-md, 6px);
      cursor: pointer;
      transition: all 0.15s ease;
      min-height: 56px;
    }

    .mcq-option:hover {
      border-color: var(--color-border-highlight, #334155);
      background: var(--color-surface-elevated, #1E293B);
    }

    .mcq-option.selected {
      border-color: var(--color-primary, #22D3EE);
      background: rgba(34, 211, 238, 0.06);
    }

    [dir="rtl"] .mcq-option.selected { box-shadow: inset -3px 0 0 var(--color-primary); }

    .mcq-option.correct {
      border-color: var(--color-success, #34D399);
      background: var(--color-success-bg);
    }
    [dir="rtl"] .mcq-option.correct { box-shadow: inset -3px 0 0 var(--color-success); }

    .mcq-option.incorrect {
      border-color: var(--color-error, #FB7185);
      background: var(--color-error-bg);
    }
    [dir="rtl"] .mcq-option.incorrect { box-shadow: inset -3px 0 0 var(--color-error); }

    .mcq-option.disabled { pointer-events: none; opacity: 0.7; }

    .option-letter {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid var(--color-border-highlight, #334155);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--color-text-secondary, #94A3B8);
      flex-shrink: 0;
    }

    .mcq-option.selected .option-letter {
      border-color: var(--color-primary);
      color: var(--color-primary);
      background: rgba(34, 211, 238, 0.15);
    }

    .mcq-option.correct .option-letter {
      border-color: var(--color-success);
      color: var(--color-text-on-bright);
      background: var(--color-success);
    }

    .mcq-option.incorrect .option-letter {
      border-color: var(--color-error);
      color: var(--color-error);
    }

    .option-text {
      flex: 1;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    /* -- True/False buttons -- */
    .tf-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-md, 16px);
    }

    .tf-btn {
      padding: var(--space-lg, 24px);
      text-align: center;
      background: var(--color-surface, #141B2D);
      border: 2px solid var(--color-border, #1E293B);
      border-radius: var(--radius-md, 6px);
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: var(--font-heading-ar);
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--color-text, #E2E8F0);
    }

    .tf-btn:hover {
      border-color: var(--color-border-highlight);
      background: var(--color-surface-elevated);
    }

    .tf-btn.selected {
      border-color: var(--color-primary);
      background: rgba(34, 211, 238, 0.08);
      color: var(--color-primary);
    }

    .tf-btn.correct {
      border-color: var(--color-success);
      background: var(--color-success-bg);
      color: var(--color-success);
    }

    .tf-btn.incorrect {
      border-color: var(--color-error);
      background: var(--color-error-bg);
      color: var(--color-error);
    }

    .tf-btn.disabled { pointer-events: none; opacity: 0.7; }

    .tf-btn .tf-label {
      display: block;
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--color-text-muted);
      margin-top: 4px;
      font-weight: 400;
    }

    /* -- Matching (dropdown) -- */
    .match-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 var(--space-sm, 8px);
    }

    .match-row {
      display: flex;
      align-items: center;
      gap: var(--space-md, 16px);
      padding: var(--space-md, 16px);
      background: var(--color-surface, #141B2D);
      border: 1px solid var(--color-border, #1E293B);
      border-radius: var(--radius-md, 6px);
      margin-bottom: var(--space-sm, 8px);
    }

    .match-term {
      flex: 1;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .match-arrow {
      color: var(--color-text-muted);
      font-family: var(--font-mono);
    }

    .match-select {
      flex: 1;
      padding: 8px 12px;
      background: var(--color-surface-elevated, #1E293B);
      border: 1px solid var(--color-border-highlight, #334155);
      border-radius: var(--radius-sm, 4px);
      color: var(--color-text, #E2E8F0);
      font-family: var(--font-body-ar);
      font-size: 0.85rem;
      direction: rtl;
    }

    .match-select:focus {
      border-color: var(--color-primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.3);
    }

    .match-row.correct { border-color: var(--color-success); }
    .match-row.incorrect { border-color: var(--color-error); }

    /* -- Ordering (sequence sort) -- */
    .order-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .order-item {
      display: flex;
      align-items: center;
      gap: var(--space-md, 16px);
      padding: var(--space-md, 16px);
      margin-bottom: var(--space-sm, 8px);
      background: var(--color-surface, #141B2D);
      border: 2px solid var(--color-border, #1E293B);
      border-radius: var(--radius-md, 6px);
      cursor: grab;
      user-select: none;
      transition: all 0.15s ease;
    }

    .order-item:hover { border-color: var(--color-border-highlight); }
    .order-item.dragging { opacity: 0.4; border-style: dashed; }
    .order-item.drag-over { border-color: var(--color-primary); transform: scale(1.01); }
    .order-item.correct { border-color: var(--color-success); background: var(--color-success-bg); }
    .order-item.incorrect { border-color: var(--color-error); background: var(--color-error-bg); }

    .order-num {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--color-primary);
      color: var(--color-text-on-bright);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-size: 0.75rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .order-text { flex: 1; font-size: 0.9rem; line-height: 1.5; }

    .order-arrows {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .order-arrow-btn {
      width: 30px;
      height: 22px;
      border: 1px solid var(--color-border, #1E293B);
      border-radius: 4px;
      background: var(--color-surface-elevated, #1E293B);
      color: var(--color-text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      transition: all 0.15s;
      padding: 0;
    }

    .order-arrow-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }
    .order-arrow-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .order-arrow-btn:focus-visible { outline: 2px solid var(--color-primary); outline-offset: 1px; }

    /* -- Feedback panel -- */
    .feedback-panel {
      margin-top: var(--space-lg, 24px);
      padding: var(--space-md, 16px) var(--space-lg, 24px);
      border-radius: var(--radius-md, 6px);
      display: none;
      animation: fbIn 0.3s ease;
    }

    .feedback-panel.show { display: block; }

    .feedback-panel.correct-fb {
      background: var(--color-success-bg);
      border: 1px solid var(--color-success);
    }

    .feedback-panel.incorrect-fb {
      background: var(--color-error-bg);
      border: 1px solid var(--color-error);
    }

    .feedback-panel .fb-title {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      font-weight: 700;
      margin-bottom: var(--space-sm, 8px);
    }

    .feedback-panel.correct-fb .fb-title { color: var(--color-success); }
    .feedback-panel.incorrect-fb .fb-title { color: var(--color-error); }

    .feedback-panel .fb-text {
      font-size: 0.9rem;
      line-height: 1.7;
      color: var(--color-text);
    }

    @keyframes fbIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* -- Trace table (feedback for loop questions) -- */
    .trace-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: var(--space-md);
      font-family: var(--font-mono);
      font-size: 0.8rem;
      direction: ltr;
      text-align: center;
    }

    .trace-table th {
      background: var(--color-surface-elevated);
      color: var(--color-primary);
      padding: 6px 10px;
      border: 1px solid var(--color-border);
    }

    .trace-table td {
      padding: 6px 10px;
      border: 1px solid var(--color-border);
      color: var(--color-text);
    }

    /* -- Submit/Next button area -- */
    .q-actions {
      display: flex;
      gap: var(--space-md, 16px);
      margin-top: var(--space-lg, 24px);
      align-items: center;
      flex-wrap: wrap;
    }

    /* -- Streak indicator -- */
    .streak-indicator {
      display: none;
      align-items: center;
      gap: 6px;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--color-warning, #FBBF24);
      padding: 4px 12px;
      border-radius: var(--radius-pill);
      background: rgba(251, 191, 36, 0.12);
      border: 1px solid rgba(251, 191, 36, 0.3);
      animation: streakPulse 0.5s ease;
    }

    .streak-indicator.show { display: inline-flex; }

    @keyframes streakPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* -- Results screen -- */
    .results-screen {
      display: none;
      text-align: center;
      padding: var(--space-2xl, 48px) var(--space-lg, 24px);
    }

    .results-screen.show { display: block; }

    .result-terminal {
      font-family: var(--font-mono);
      font-size: 0.85rem;
      padding: var(--space-lg, 24px);
      background: var(--color-background, #0B1120);
      border: 1px solid var(--color-border, #1E293B);
      border-radius: var(--radius-md, 6px);
      text-align: left;
      direction: ltr;
      margin: var(--space-lg) auto;
      max-width: 500px;
      line-height: 1.8;
    }

    .result-score-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: var(--space-lg) auto;
      font-family: var(--font-mono);
    }

    .result-score-circle.pass {
      border-color: var(--color-success);
      box-shadow: var(--glow-accent);
    }

    .result-score-circle.fail {
      border-color: var(--color-error);
      box-shadow: var(--glow-error);
    }

    .result-score-circle .score-pct {
      font-size: 2rem;
      font-weight: 700;
      line-height: 1;
    }

    .result-score-circle.pass .score-pct { color: var(--color-success); }
    .result-score-circle.fail .score-pct { color: var(--color-error); }

    .result-score-circle .score-label { font-size: 0.7rem; color: var(--color-text-muted); }

    /* Objective breakdown */
    .obj-breakdown {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-md);
      margin: var(--space-lg) auto;
      max-width: 600px;
      text-align: right;
    }

    .obj-card {
      padding: var(--space-md);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
    }

    .obj-card .obj-name {
      font-size: 0.8rem;
      color: var(--color-text-secondary);
      margin-bottom: 4px;
    }

    .obj-card .obj-score {
      font-family: var(--font-mono);
      font-size: 1.1rem;
      font-weight: 700;
    }

    .obj-card .obj-score.good { color: var(--color-success); }
    .obj-card .obj-score.weak { color: var(--color-error); }

    /* Remediation links */
    .remediation-links {
      margin-top: var(--space-lg);
      text-align: right;
    }

    .remediation-links h4 {
      font-size: 0.9rem;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-sm);
    }

    .remediation-link {
      display: inline-block;
      padding: 6px 14px;
      margin: 4px;
      background: var(--color-surface);
      border: 1px solid var(--color-border-highlight);
      border-radius: var(--radius-sm);
      color: var(--color-primary);
      font-family: var(--font-mono);
      font-size: 0.8rem;
      text-decoration: none;
      transition: all 0.15s;
    }

    .remediation-link:hover {
      border-color: var(--color-primary);
      background: rgba(34, 211, 238, 0.06);
    }

    /* -- Points display -- */
    .pts-display {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--gradient-points);
      color: var(--color-text-on-bright);
      padding: 4px 14px;
      border-radius: var(--radius-pill);
      font-family: var(--font-mono);
      font-size: 0.8rem;
      font-weight: 700;
    }

    .pts-float {
      position: fixed;
      z-index: 1000;
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 1.2rem;
      pointer-events: none;
      animation: ptsFloat 1s ease forwards;
    }

    .pts-float.correct-float { color: var(--color-success); }
    .pts-float.streak-float { color: var(--color-warning); }

    @keyframes ptsFloat {
      0%   { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-50px); }
    }

    /* -- Responsive -- */
    @media (max-width: 600px) {
      .tf-options { grid-template-columns: 1fr; }
      .obj-breakdown { grid-template-columns: 1fr; }
      .match-row { flex-direction: column; }
    }

    @media (prefers-reduced-motion: reduce) {
      .question-slide, .feedback-panel, .streak-indicator, .pts-float { animation: none; }
      .pts-float { display: none; }
    }
  </style>
</head>
<body>
  <!-- Skip navigation -->
  <a href="#main-content" class="skip-link">تخطي إلى المحتوى الرئيسي</a>

  <div class="sco-container">
    <!-- Header -->
    <header class="sco-header" style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-md) 0; border-bottom: 1px solid var(--color-border);">
      <div style="flex: 1;">
        <div class="progress-bar" style="height: 4px; margin-bottom: var(--space-sm);">
          <div class="progress-fill" id="progress" style="width: 0%; height: 100%;"></div>
        </div>
        <h1 class="lesson-title" style="font-size: var(--font-size-h2); margin: 0;">
          الاختبار البعدي
          <span style="font-family: var(--font-mono); font-size: 0.6em; color: var(--color-text-muted); display: block; direction: ltr; text-align: right;">// Post-test: Chapter 1</span>
        </h1>
      </div>
      <div style="display: flex; align-items: center; gap: var(--space-md);">
        <div class="streak-indicator" id="streakBadge">
          <span>&#128293;</span> <span id="streakCount">0</span>x
        </div>
        <div class="pts-display" id="ptsBadge" aria-live="polite">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          <span id="ptsValue">0</span>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="sco-content" id="main-content" role="main">

      <!-- Intro slide -->
      <div class="question-slide active" id="introSlide">
        <div class="quiz-viewport" style="justify-content: center; text-align: center; padding: var(--space-2xl) 0;">
          <div class="circuit-corners" style="padding: var(--space-2xl); background: var(--gradient-hero); border-radius: var(--radius-md); border: 1px solid var(--color-border-highlight);">
            <p class="overline overline--comment stagger-item" style="direction: ltr; margin-bottom: var(--space-md);">FINAL_ASSESSMENT</p>
            <h2 class="stagger-item" style="font-size: var(--font-size-h1); margin-bottom: var(--space-md);">الاختبار البعدي: الوحدة الأولى</h2>
            <p class="stagger-item" style="color: var(--color-text-secondary); font-size: 0.95rem; line-height: 1.8; margin-bottom: var(--space-lg);">
              اختبار تقييمي يقيس إتقان جميع أهداف الوحدة الأولى في التفكير الحاسوبي.
            </p>
            <div class="stagger-item" style="display: flex; justify-content: center; gap: var(--space-lg); flex-wrap: wrap; margin-bottom: var(--space-xl);">
              <div style="text-align: center;">
                <div style="font-family: var(--font-mono); font-size: 1.5rem; font-weight: 700; color: var(--color-primary);">15</div>
                <div style="font-size: 0.8rem; color: var(--color-text-muted);">سؤال (Questions)</div>
              </div>
              <div style="text-align: center;">
                <div style="font-family: var(--font-mono); font-size: 1.5rem; font-weight: 700; color: var(--color-warning);">70%</div>
                <div style="font-size: 0.8rem; color: var(--color-text-muted);">درجة النجاح (Pass)</div>
              </div>
              <div style="text-align: center;">
                <div style="font-family: var(--font-mono); font-size: 1.5rem; font-weight: 700; color: var(--color-secondary);">15</div>
                <div style="font-size: 0.8rem; color: var(--color-text-muted);">دقيقة (Minutes)</div>
              </div>
            </div>
            <button class="btn-primary stagger-item" id="startQuizBtn" style="padding: 14px 40px; font-size: 1rem;">
              ابدأ الاختبار &#8592;
            </button>
          </div>
        </div>
      </div>

      <!-- Question slides container (populated by JS) -->
      <div id="questionsContainer"></div>

      <!-- Results screen -->
      <div class="question-slide results-screen" id="resultsScreen">
        <div id="resultsContent"></div>
      </div>

    </main>

    <!-- Navigation -->
    <nav class="sco-nav" id="quizNav" style="display: none; justify-content: space-between; align-items: center; padding: var(--space-md) 0; border-top: 1px solid var(--color-border);">
      <button class="btn-prev" id="qPrevBtn" disabled>&#8594; السابق</button>
      <span class="page-indicator" id="qPageIndicator" style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--color-text-muted);">
        <span style="direction: ltr; unicode-bidi: embed;">Question 1 of 15</span>
      </span>
      <button class="btn-next" id="qNextBtn">التالي &#8592;</button>
    </nav>
  </div>

  <!-- Screen reader -->
  <div id="srAnnounce" class="sr-only" aria-live="assertive"></div>

  <!-- SCORM & Engine -->
  <script src="../shared/scorm-api.js"></script>
  <script src="../shared/behavior-tracker.js"></script>
  <script src="../shared/gamification.js"></script>

  <script>
  /* ==========================================================================
     SCO 18 — Post-test: Chapter 1
     ==========================================================================
     15 questions from the verified question bank. Types: MCQ, T/F, Matching,
     Ordering. Immediate feedback, SCORM interaction reporting, gamification.
     ========================================================================== */

  (function() {
    'use strict';

    // ---- SCORM ----
    var scorm = new SCORMWrapper();
    scorm.initialize();
    var startTime = Date.now();

    // ---- Question Bank (from computational-thinking_ch1_posttest.json) ----
    // IMPORTANT: These are copied EXACTLY from the verified JSON. Do NOT modify.
    var QUESTIONS = [
      // Q1: MCQ - Define CT (Easy, TO-1, Remember)
      {
        id: 'q_post_01', type: 'mcq', objective: 'TO-1', bloom: 'remember', difficulty: 'easy', points: 10,
        stem: 'أي مما يلي يُعرّف التفكير الحاسوبي (Computational Thinking) بأفضل شكل؟',
        options: [
          { id: 'a', text: 'القدرة على كتابة الكود بلغة برمجة', correct: false },
          { id: 'b', text: 'مجموعة من أساليب حل المشكلات تتضمن التعبير عن المسائل وحلولها بطرق يمكن للحاسوب تنفيذها', correct: true },
          { id: 'c', text: 'التفكير في كيفية عمل الحاسوب داخلياً', correct: false },
          { id: 'd', text: 'استخدام الحاسوب لحل المعادلات الرياضية', correct: false }
        ],
        feedbackCorrect: 'صحيح! التفكير الحاسوبي هو مجموعة من أساليب حل المشكلات -- تشمل التحليل والتعرف على الأنماط والتجريد والتفكير الخوارزمي -- للتعبير عن المسائل وحلولها بطرق يمكن للحاسوب تنفيذها. أشاعت هذا المفهوم جانيت وينغ عام 2006.',
        feedbackIncorrect: 'ليس تماماً -- لكن هذه هي طريقة التعلم! التفكير الحاسوبي ليس مجرد برمجة أو فهم للأجهزة. إنه نهج أوسع لحل المشكلات يتضمن التحليل والتعرف على الأنماط والتجريد والتفكير الخوارزمي.'
      },
      // Q2: MCQ - Decomposition (Easy, TO-1, Understand)
      {
        id: 'q_post_02', type: 'mcq', objective: 'TO-1', bloom: 'understand', difficulty: 'easy', points: 10,
        stem: 'قسّم فريق برمجي تطبيق تجارة إلكترونية كبيراً إلى وحدات أصغر: مصادقة المستخدم، كتالوج المنتجات، سلة التسوق، ومعالجة الدفع. أي ركن من أركان التفكير الحاسوبي (CT Pillars) يوضحه هذا بأفضل شكل؟',
        options: [
          { id: 'a', text: 'التعرف على الأنماط (Pattern Recognition)', correct: false },
          { id: 'b', text: 'التجريد (Abstraction)', correct: false },
          { id: 'c', text: 'التحليل (Decomposition)', correct: true },
          { id: 'd', text: 'التفكير الخوارزمي (Algorithmic Thinking)', correct: false }
        ],
        feedbackCorrect: 'صحيح! التحليل (Decomposition) يعني تقسيم مشكلة معقدة إلى أجزاء أصغر يمكن إدارتها. تقسيم تطبيق كبير إلى وحدات متخصصة هو مثال كلاسيكي على التحليل.',
        feedbackIncorrect: 'ليس تماماً -- لكنك تبني فهمك! الإجراء الأساسي هنا هو تقسيم نظام كبير إلى أجزاء أصغر. هذا هو التحليل (Decomposition).'
      },
      // Q3: Matching - CT pillars to scenarios (Medium, TO-1, Understand)
      {
        id: 'q_post_03', type: 'matching', objective: 'TO-1', bloom: 'understand', difficulty: 'medium', points: 10,
        stem: 'طابق كل ركن من أركان التفكير الحاسوبي (CT Pillars) مع السيناريو الذي يمثله بأفضل شكل:',
        items: [
          { id: '1', term: 'التحليل (Decomposition)' },
          { id: '2', term: 'التعرف على الأنماط (Pattern Recognition)' },
          { id: '3', term: 'التجريد (Abstraction)' },
          { id: '4', term: 'التفكير الخوارزمي (Algorithmic Thinking)' }
        ],
        targets: [
          { id: 'a', definition: 'طبيب يقسّم أعراض المريض إلى فئات (تنفسية، هضمية، عصبية) لتشخيص المرض', matchTo: '1' },
          { id: 'b', definition: 'محلل بيانات يلاحظ أن المبيعات تزداد دائماً في ديسمبر عبر جميع فئات المنتجات', matchTo: '2' },
          { id: 'c', definition: 'خريطة المترو تُظهر فقط أسماء المحطات والتوصيلات متجاهلةً الجغرافيا الفعلية', matchTo: '3' },
          { id: 'd', definition: 'وصفة طبخ تسرد خطوات دقيقة بالترتيب: اغلِ الماء، أضف المعكرونة، اطبخ 8 دقائق، صفِّ الماء، قدّم', matchTo: '4' }
        ],
        feedbackCorrect: 'مطابقة ممتازة! أنت تفهم بوضوح كيف يُطبَّق كل ركن من أركان التفكير الحاسوبي في سياقات واقعية.',
        feedbackIncorrect: 'بعض المطابقات تحتاج تعديلاً -- لنراجع معاً! التحليل = التقسيم إلى أجزاء. التعرف على الأنماط = ملاحظة الاتجاهات المتكررة. التجريد = التبسيط بإزالة التفاصيل غير المهمة. التفكير الخوارزمي = خطوات مرتبة ودقيقة.'
      },
      // Q4: MCQ - Abstraction scenario (Medium, TO-1, Apply)
      {
        id: 'q_post_04', type: 'mcq', objective: 'TO-1', bloom: 'apply', difficulty: 'medium', points: 10,
        stem: 'أنت تصمم تطبيقاً للهاتف وقررت التركيز فقط على تدفق المستخدم الأساسي (التسجيل، التصفح، الشراء) مع تجاهل الميزات الثانوية مثل السمات والمشاركة الاجتماعية حالياً. أي ركن من أركان التفكير الحاسوبي تُطبّقه؟',
        options: [
          { id: 'a', text: 'التحليل (Decomposition)', correct: false },
          { id: 'b', text: 'التعرف على الأنماط (Pattern Recognition)', correct: false },
          { id: 'c', text: 'التجريد (Abstraction)', correct: true },
          { id: 'd', text: 'التفكير الخوارزمي (Algorithmic Thinking)', correct: false }
        ],
        feedbackCorrect: 'صحيح! التجريد (Abstraction) يعني التركيز على ما هو جوهري وتجاهل التفاصيل غير المهمة.',
        feedbackIncorrect: 'ليس تماماً -- فكّر في الإجراء هنا. أنت تزيل ما ليس ضرورياً وتركّز على ما يهم. هذا هو التجريد (Abstraction).'
      },
      // Q5: True/False - Logical thinking definition (Easy, TO-2, Remember)
      {
        id: 'q_post_05', type: 'tf', objective: 'TO-2', bloom: 'remember', difficulty: 'easy', points: 10,
        stem: 'التفكير المنطقي (Logical Thinking) هو عملية استخدام تفكير منظم ومتسق لاستخلاص نتائج صحيحة من مقدمات معطاة.',
        correct: true,
        feedbackCorrect: 'صحيح! التفكير المنطقي يتضمن تفكيراً منظماً قائماً على قواعد حيث تتبع النتائج بالضرورة من المقدمات.',
        feedbackIncorrect: 'في الواقع، هذه العبارة صحيحة! التفكير المنطقي هو فعلاً استخدام تفكير منظم ومتسق للوصول إلى نتائج صحيحة.'
      },
      // Q6: MCQ - Valid syllogism (Medium, TO-2, Apply)
      {
        id: 'q_post_06', type: 'mcq', objective: 'TO-2', bloom: 'apply', difficulty: 'medium', points: 10,
        stem: 'تأمّل هذه الحجة:\n\nالمقدمة 1: جميع قواعد البيانات (Databases) تخزّن البيانات.\nالمقدمة 2: MySQL هو قاعدة بيانات.\nالاستنتاج: إذن، MySQL يخزّن البيانات.\n\nهل هذه الحجة صحيحة منطقياً (Logically Valid)؟',
        options: [
          { id: 'a', text: 'صحيحة -- الاستنتاج يتبع منطقياً من المقدمات', correct: true },
          { id: 'b', text: 'غير صحيحة -- الاستنتاج لا يتبع من المقدمات', correct: false },
          { id: 'c', text: 'غير صحيحة -- ترتكب مغالطة تأكيد التالي (Affirming the Consequent)', correct: false },
          { id: 'd', text: 'لا يمكن تحديدها بدون معلومات إضافية', correct: false }
        ],
        feedbackCorrect: 'صحيح! هذا قياس منطقي صحيح (استنتاج استنباطي). البنية هي: كل أ هو ب. س هو أ. إذن، س هو ب. وهذا صحيح دائماً.',
        feedbackIncorrect: 'ليس تماماً -- لنتتبع المنطق معاً! البنية هي: "كل أ هو ب. س هو أ. إذن، س هو ب." هذا قياس استنباطي صحيح.'
      },
      // Q7: Matching - Boolean logic (Medium, TO-2, Apply)
      {
        id: 'q_post_07', type: 'matching', objective: 'TO-2', bloom: 'apply', difficulty: 'medium', points: 10,
        stem: 'بافتراض: x = TRUE ، y = FALSE. طابق كل تعبير منطقي (Boolean Expression) بنتيجته الصحيحة:',
        items: [
          { id: '1', term: 'x AND y' },
          { id: '2', term: 'x OR y' },
          { id: '3', term: 'NOT x' },
          { id: '4', term: 'NOT y' }
        ],
        targets: [
          { id: 'a', definition: 'FALSE (خطأ)', matchTo: '1' },
          { id: 'b', definition: 'TRUE (صحيح)', matchTo: '2' },
          { id: 'c', definition: 'FALSE (خطأ)', matchTo: '3' },
          { id: 'd', definition: 'TRUE (صحيح)', matchTo: '4' }
        ],
        feedbackCorrect: 'ممتاز! قيّمت جميع التعبيرات المنطقية بشكل صحيح.',
        feedbackIncorrect: 'لنراجع المنطق البولياني خطوة بخطوة! x AND y = FALSE، x OR y = TRUE، NOT x = FALSE، NOT y = TRUE.'
      },
      // Q8: Ordering - Linear search steps (Medium, TO-2, Apply)
      {
        id: 'q_post_08', type: 'ordering', objective: 'TO-2', bloom: 'apply', difficulty: 'medium', points: 10,
        stem: 'رتّب الخطوات التالية لخوارزمية البحث الخطي (Linear Search) بالترتيب الصحيح للعثور على قيمة مستهدفة في قائمة:',
        items: [
          { id: 's1', text: 'ابدأ من العنصر الأول في القائمة', correctPosition: 1 },
          { id: 's2', text: 'قارن العنصر الحالي بالقيمة المستهدفة', correctPosition: 2 },
          { id: 's3', text: 'إذا تطابقا، أرجع الموضع الحالي', correctPosition: 3 },
          { id: 's4', text: 'إذا لم يتطابقا، انتقل إلى العنصر التالي', correctPosition: 4 },
          { id: 's5', text: 'كرّر حتى يُعثر على المستهدف أو يُصل إلى نهاية القائمة', correctPosition: 5 },
          { id: 's6', text: 'إذا وصلت إلى نهاية القائمة بدون العثور على المستهدف، أبلغ "غير موجود"', correctPosition: 6 }
        ],
        feedbackCorrect: 'ترتيب مثالي! البحث الخطي يبدأ من البداية، يفحص كل عنصر، يرجع الموضع إذا عُثر عليه، ينتقل للأمام إذا لم يُعثر عليه.',
        feedbackIncorrect: 'قريب، لكن الترتيب يحتاج تعديلاً -- فكّر فيه كفحص الطلاب في صف واحداً تلو الآخر.'
      },
      // Q9: True/False - Purpose of iteration (Easy, TO-3, Understand)
      {
        id: 'q_post_09', type: 'tf', objective: 'TO-3', bloom: 'understand', difficulty: 'easy', points: 10,
        stem: 'في تصميم الخوارزميات، التكرار (Iteration / Loops) يسمح بتنفيذ كتلة من التعليمات بشكل متكرر حتى يتحقق شرط محدد.',
        correct: true,
        feedbackCorrect: 'صحيح! التكرار (أو الحلقات) هو بنية تحكم تُعيد تنفيذ كتلة من الكود بينما أو حتى يتحقق شرط.',
        feedbackIncorrect: 'في الواقع، هذه العبارة صحيحة! التكرار يعني إعادة تنفيذ التعليمات. حلقة FOR تكرر عدداً محدداً من المرات، وحلقة WHILE تكرر طالما شرطها صحيح.'
      },
      // Q10: MCQ - Predict loop output (Hard, TO-3, Apply)
      {
        id: 'q_post_10', type: 'mcq', objective: 'TO-3', bloom: 'apply', difficulty: 'hard', points: 10,
        stem: 'ما قيمة \'total\' بعد تنفيذ هذا الكود الوهمي (Pseudocode)؟',
        stemCode: 'total = 0\nFOR i = 1 TO 4\n    total = total + (i * 2)\nEND FOR',
        options: [
          { id: 'a', text: '8', correct: false },
          { id: 'b', text: '10', correct: false },
          { id: 'c', text: '20', correct: true },
          { id: 'd', text: '24', correct: false }
        ],
        traceTable: { headers: ['Iteration', 'i', 'i * 2', 'total'], rows: [['1','1','2','2'],['2','2','4','6'],['3','3','6','12'],['4','4','8','20']] },
        feedbackCorrect: 'صحيح! تتبع الحلقة: i=1: total = 0 + 2 = 2. i=2: total = 2 + 4 = 6. i=3: total = 6 + 6 = 12. i=4: total = 12 + 8 = 20.',
        feedbackIncorrect: 'ليس تماماً -- جداول التتبع هي أفضل صديق لك هنا! i=1: total=2، i=2: total=6، i=3: total=12، i=4: total=20.'
      },
      // Q11: MCQ - Trace if/else (Medium, TO-3, Apply)
      {
        id: 'q_post_11', type: 'mcq', objective: 'TO-3', bloom: 'apply', difficulty: 'medium', points: 10,
        stem: 'ما مخرجات الكود الوهمي التالي عندما score = 75؟',
        stemCode: 'IF score >= 90 THEN\n    PRINT "A"\nELSE IF score >= 80 THEN\n    PRINT "B"\nELSE IF score >= 70 THEN\n    PRINT "C"\nELSE\n    PRINT "F"\nEND IF',
        options: [
          { id: 'a', text: 'A', correct: false },
          { id: 'b', text: 'B', correct: false },
          { id: 'c', text: 'C', correct: true },
          { id: 'd', text: 'F', correct: false }
        ],
        feedbackCorrect: 'صحيح! عندما score = 75: 75 >= 90؟ لا. 75 >= 80؟ لا. 75 >= 70؟ نعم! فيطبع "C".',
        feedbackIncorrect: 'لنتتبعها معاً! 75 >= 90؟ خطأ. 75 >= 80؟ خطأ. 75 >= 70؟ صحيح -- نفّذ: اطبع "C". الجواب هو C.'
      },
      // Q12: MCQ - Combined iteration + selection (Hard, TO-3, Apply)
      {
        id: 'q_post_12', type: 'mcq', objective: 'TO-3', bloom: 'apply', difficulty: 'hard', points: 10,
        stem: 'ما قيمة \'count\' بعد تنفيذ هذا الكود الوهمي؟',
        stemCode: 'numbers = [4, 7, 2, 9, 1, 8]\ncount = 0\nFOR each num in numbers\n    IF num > 5 THEN\n        count = count + 1\n    END IF\nEND FOR',
        options: [
          { id: 'a', text: '2', correct: false },
          { id: 'b', text: '3', correct: true },
          { id: 'c', text: '4', correct: false },
          { id: 'd', text: '6', correct: false }
        ],
        traceTable: { headers: ['num', 'num > 5?', 'count'], rows: [['4','No','0'],['7','Yes','1'],['2','No','1'],['9','Yes','2'],['1','No','2'],['8','Yes','3']] },
        feedbackCorrect: 'صحيح! الحلقة تفحص كل رقم: 4 (لا)، 7 (نعم، count=1)، 2 (لا)، 9 (نعم، count=2)، 1 (لا)، 8 (نعم، count=3).',
        feedbackIncorrect: 'ليس تماماً -- لنتتبع كل عنصر! 4>5؟ لا. 7>5؟ نعم (count=1). 2>5؟ لا. 9>5؟ نعم (count=2). 1>5؟ لا. 8>5؟ نعم (count=3).'
      },
      // Q13: MCQ - Infinite loop bug (Hard, TO-4, Evaluate)
      {
        id: 'q_post_13', type: 'mcq', objective: 'TO-4', bloom: 'evaluate', difficulty: 'hard', points: 10,
        stem: 'هذه الخوارزمية من المفترض أن تعد تنازلياً من 10 إلى 1، لكن فيها خطأ. ما المشكلة؟',
        stemCode: 'x = 10\nWHILE x > 0\n    PRINT x\n    x = x + 1\nEND WHILE',
        options: [
          { id: 'a', text: 'شرط WHILE يجب أن يكون x < 0', correct: false },
          { id: 'b', text: 'المتغير x يجب أن يبدأ من 1 بدلاً من 10', correct: false },
          { id: 'c', text: 'خطوة التحديث يجب أن تكون x = x - 1 (طرح بدل جمع)، مما يسبب حلقة لا نهائية (Infinite Loop)', correct: true },
          { id: 'd', text: 'PRINT يجب أن تأتي بعد خطوة التحديث', correct: false }
        ],
        feedbackCorrect: 'صحيح! الخطأ في خطوة التحديث: x = x + 1 تجعل x تكبر (11، 12، 13...)، فيبقى الشرط x > 0 صحيحاً دائماً = حلقة لا نهائية.',
        feedbackIncorrect: 'ليس تماماً -- انظر بعناية لما يحدث لـ x في كل تكرار. بدءاً من x=10، الحلقة تضيف 1 كل مرة: x تصبح 11، 12، 13... الحلقة لا تتوقف أبداً!'
      },
      // Q14: True/False - Off-by-one error (Hard, TO-4, Evaluate)
      {
        id: 'q_post_14', type: 'tf', objective: 'TO-4', bloom: 'evaluate', difficulty: 'hard', points: 10,
        stem: 'تأمّل هذا الكود الوهمي الذي من المفترض أن يطبع الأرقام من 1 إلى 5:',
        stemCode: 'i = 1\nWHILE i < 5\n    PRINT i\n    i = i + 1\nEND WHILE',
        stemSuffix: 'هذه الخوارزمية تطبع بشكل صحيح 1، 2، 3، 4، و 5.',
        correct: false,
        feedbackCorrect: 'صحيح -- العبارة خاطئة! الحلقة تعمل بينما i < 5، فتطبع 1، 2، 3، 4 ثم تتوقف عندما i تصبح 5 (لأن 5 < 5 خاطئة). لا تطبع 5! هذا خطأ الواحد الزائد أو الناقص (Off-by-one Error). الإصلاح: i <= 5.',
        feedbackIncorrect: 'ليس تماماً -- لنتتبعها بعناية. i=1 (1<5؟ نعم)، i=2 (نعم)، i=3 (نعم)، i=4 (نعم)، i=5 (5<5؟ لا -- توقف!). تطبع فقط 1 إلى 4. العبارة خاطئة!'
      },
      // Q15: Ordering - Fix broken find-minimum algorithm (Hard, TO-4, Evaluate)
      {
        id: 'q_post_15', type: 'ordering', objective: 'TO-4', bloom: 'evaluate', difficulty: 'hard', points: 10,
        stem: 'هذه الخوارزمية تجد أصغر رقم في قائمة. رتّب الخطوات بالترتيب الصحيح لإصلاح النسخة المعطوبة:',
        stemNote: 'النسخة المعطوبة (للمرجع): result = 0 / FOR each num in list / IF num < result THEN result = num / PRINT result',
        items: [
          { id: 's1', text: 'اجعل result = العنصر الأول في القائمة', correctPosition: 1 },
          { id: 's2', text: 'لكل num متبقٍ في القائمة (بدءاً من العنصر الثاني)', correctPosition: 2 },
          { id: 's3', text: 'إذا كان num < result فاجعل result = num', correctPosition: 3 },
          { id: 's4', text: 'نهاية الحلقة (كرر لجميع العناصر المتبقية)', correctPosition: 4 },
          { id: 's5', text: 'اطبع result (أصغر رقم تم العثور عليه)', correctPosition: 5 }
        ],
        feedbackCorrect: 'تقييم وإصلاح ممتاز! النسخة المعطوبة كان فيها خطأ: تهيئة result بـ 0 بدلاً من أول عنصر في القائمة.',
        feedbackIncorrect: 'قريب! النقطة الأساسية: النسخة المعطوبة تبدأ result بـ 0. الإصلاح: (1) هيّئ result = أول عنصر. (2) كرر للمتبقية. (3) حدّث إذا أصغر. (4) نهاية الحلقة. (5) اطبع.'
      }
    ];

    var TOTAL_QUESTIONS = QUESTIONS.length;
    var PASSING_SCORE = 70;
    var POINTS_PER_Q = 10;

    // ---- State ----
    var currentQ = -1; // -1 = intro
    var answers = {};   // questionId -> learner answer
    var answered = {};  // questionId -> true (submitted)
    var results = {};   // questionId -> { correct: bool, answer: ... }
    var totalPoints = 0;
    var streak = 0;
    var maxStreak = 0;
    var questionStartTimes = {};

    // Resume support
    var savedState = null;
    try {
      var raw = scorm.getValue('cmi.suspend_data');
      if (raw) savedState = JSON.parse(raw);
    } catch(e) {}

    if (savedState && savedState.sco === 'sco_18') {
      answers = savedState.answers || {};
      answered = savedState.answered || {};
      results = savedState.results || {};
      totalPoints = savedState.totalPoints || 0;
      streak = savedState.streak || 0;
      currentQ = savedState.currentQ || -1;
    }

    updatePtsDisplay();

    // ==========================================================================
    // BUILD QUESTION SLIDES
    // ==========================================================================

    var container = document.getElementById('questionsContainer');

    QUESTIONS.forEach(function(q, idx) {
      var slide = document.createElement('div');
      slide.className = 'question-slide';
      slide.id = 'qSlide_' + idx;

      var html = '<div class="quiz-viewport">';

      // Question header
      html += '<div class="q-header">';
      html += '<span class="q-number" style="direction: ltr;">[' + (idx + 1) + '/' + TOTAL_QUESTIONS + '] Running test...</span>';
      html += '<div style="display: flex; gap: 6px;">';
      html += '<span class="q-type-badge">' + getTypeBadge(q.type) + '</span>';
      html += '<span class="q-difficulty ' + q.difficulty + '">' + q.difficulty + '</span>';
      html += '</div>';
      html += '</div>';

      // Stem
      html += '<div class="q-stem">' + q.stem;
      if (q.stemCode) {
        html += '<pre>' + escapeHtml(q.stemCode) + '</pre>';
      }
      if (q.stemSuffix) {
        html += '<p style="margin-top: var(--space-md);">' + q.stemSuffix + '</p>';
      }
      if (q.stemNote) {
        html += '<p style="margin-top: var(--space-sm); font-family: var(--font-mono); font-size: 0.8rem; color: var(--color-text-muted); direction: ltr; text-align: left;">' + escapeHtml(q.stemNote) + '</p>';
      }
      html += '</div>';

      // Render by type
      if (q.type === 'mcq') {
        html += renderMCQ(q, idx);
      } else if (q.type === 'tf') {
        html += renderTF(q, idx);
      } else if (q.type === 'matching') {
        html += renderMatching(q, idx);
      } else if (q.type === 'ordering') {
        html += renderOrdering(q, idx);
      }

      // Submit button
      html += '<div class="q-actions" id="actions_' + idx + '">';
      html += '<button class="btn-primary" id="submitBtn_' + idx + '" onclick="submitQuestion(' + idx + ')">تحقق من الإجابة</button>';
      html += '</div>';

      // Feedback area
      html += '<div class="feedback-panel" id="feedback_' + idx + '"></div>';

      html += '</div>'; // end quiz-viewport
      slide.innerHTML = html;
      container.appendChild(slide);
    });

    // ==========================================================================
    // RENDER FUNCTIONS
    // ==========================================================================

    function getTypeBadge(type) {
      var map = { mcq: 'MCQ', tf: 'T/F', matching: 'MATCH', ordering: 'ORDER' };
      return map[type] || type;
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function renderMCQ(q, idx) {
      var h = '<div class="mcq-options" id="options_' + idx + '">';
      q.options.forEach(function(opt) {
        var isSelected = answers[q.id] === opt.id;
        var isAnswered = answered[q.id];
        var cls = 'mcq-option';
        if (isSelected) cls += ' selected';
        if (isAnswered && isSelected && opt.correct) cls += ' correct';
        if (isAnswered && isSelected && !opt.correct) cls += ' incorrect';
        if (isAnswered && !isSelected && opt.correct) cls += ' correct';
        if (isAnswered) cls += ' disabled';

        h += '<div class="' + cls + '" data-qidx="' + idx + '" data-opt="' + opt.id + '" role="radio" tabindex="0" aria-checked="' + (isSelected ? 'true' : 'false') + '" onclick="selectMCQ(' + idx + ', \'' + opt.id + '\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();selectMCQ(' + idx + ', \'' + opt.id + '\')}">';
        h += '<span class="option-letter">' + opt.id.toUpperCase() + '</span>';
        h += '<span class="option-text">' + opt.text + '</span>';
        h += '</div>';
      });
      h += '</div>';
      return h;
    }

    function renderTF(q, idx) {
      var h = '<div class="tf-options" id="options_' + idx + '">';
      var trueSelected = answers[q.id] === 'true';
      var falseSelected = answers[q.id] === 'false';
      var isAns = answered[q.id];

      var trueCls = 'tf-btn';
      if (trueSelected) trueCls += ' selected';
      if (isAns && trueSelected && q.correct) trueCls += ' correct';
      if (isAns && trueSelected && !q.correct) trueCls += ' incorrect';
      if (isAns && !trueSelected && q.correct) trueCls += ' correct';
      if (isAns) trueCls += ' disabled';

      var falseCls = 'tf-btn';
      if (falseSelected) falseCls += ' selected';
      if (isAns && falseSelected && !q.correct) falseCls += ' correct';
      if (isAns && falseSelected && q.correct) falseCls += ' incorrect';
      if (isAns && !falseSelected && !q.correct) falseCls += ' correct';
      if (isAns) falseCls += ' disabled';

      h += '<button class="' + trueCls + '" onclick="selectTF(' + idx + ', \'true\')" aria-pressed="' + (trueSelected ? 'true' : 'false') + '">صحيح<span class="tf-label">TRUE</span></button>';
      h += '<button class="' + falseCls + '" onclick="selectTF(' + idx + ', \'false\')" aria-pressed="' + (falseSelected ? 'true' : 'false') + '">خطأ<span class="tf-label">FALSE</span></button>';
      h += '</div>';
      return h;
    }

    function renderMatching(q, idx) {
      var h = '<div id="options_' + idx + '">';
      // Shuffle targets for dropdown
      var shuffledTargets = q.targets.slice();
      for (var i = shuffledTargets.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var t = shuffledTargets[i]; shuffledTargets[i] = shuffledTargets[j]; shuffledTargets[j] = t;
      }

      q.items.forEach(function(item) {
        var savedAnswer = answers[q.id] && answers[q.id][item.id];
        var isAns = answered[q.id];
        var isCorrect = isAns && savedAnswer === q.targets.find(function(t) { return t.matchTo === item.id; }).id;
        var cls = 'match-row' + (isAns ? (isCorrect ? ' correct' : ' incorrect') : '');

        h += '<div class="' + cls + '">';
        h += '<span class="match-term">' + item.term + '</span>';
        h += '<span class="match-arrow" style="direction: ltr;">&#8594;</span>';
        h += '<select class="match-select" data-qidx="' + idx + '" data-item="' + item.id + '" onchange="selectMatch(' + idx + ', \'' + item.id + '\', this.value)"' + (isAns ? ' disabled' : '') + '>';
        h += '<option value="">-- اختر --</option>';
        shuffledTargets.forEach(function(t) {
          var sel = savedAnswer === t.id ? ' selected' : '';
          h += '<option value="' + t.id + '"' + sel + '>' + t.definition + '</option>';
        });
        h += '</select>';
        h += '</div>';
      });
      h += '</div>';
      return h;
    }

    function renderOrdering(q, idx) {
      // Shuffle items for display
      var displayItems = q.items.slice();
      if (!answered[q.id]) {
        for (var i = displayItems.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1));
          var t = displayItems[i]; displayItems[i] = displayItems[j]; displayItems[j] = t;
        }
      } else if (answers[q.id]) {
        // Restore saved order
        var savedOrder = answers[q.id];
        displayItems = savedOrder.map(function(sid) { return q.items.find(function(it) { return it.id === sid; }); }).filter(Boolean);
      }

      var h = '<ul class="order-list" id="orderList_' + idx + '" data-qidx="' + idx + '">';
      displayItems.forEach(function(item, i) {
        var isAns = answered[q.id];
        var isCorrectPos = isAns && item.correctPosition === (i + 1);
        var cls = 'order-item' + (isAns ? (isCorrectPos ? ' correct' : ' incorrect') : '');

        h += '<li class="' + cls + '" data-id="' + item.id + '" draggable="' + (!isAns) + '" tabindex="0">';
        h += '<span class="order-num">' + (i + 1) + '</span>';
        h += '<span class="order-text">' + item.text + '</span>';
        if (!isAns) {
          h += '<div class="order-arrows">';
          h += '<button class="order-arrow-btn" onclick="moveOrderItem(' + idx + ', this, -1)" aria-label="تحريك لأعلى"' + (i === 0 ? ' disabled' : '') + '>&#9650;</button>';
          h += '<button class="order-arrow-btn" onclick="moveOrderItem(' + idx + ', this, 1)" aria-label="تحريك لأسفل"' + (i === displayItems.length - 1 ? ' disabled' : '') + '>&#9660;</button>';
          h += '</div>';
        }
        h += '</li>';
      });
      h += '</ul>';
      return h;
    }

    // ==========================================================================
    // INTERACTION HANDLERS (global scope for inline event handlers)
    // ==========================================================================

    window.selectMCQ = function(idx, optId) {
      if (answered[QUESTIONS[idx].id]) return;
      answers[QUESTIONS[idx].id] = optId;

      // Update visual state
      var opts = document.querySelectorAll('#options_' + idx + ' .mcq-option');
      opts.forEach(function(o) {
        o.classList.remove('selected');
        o.setAttribute('aria-checked', 'false');
        if (o.dataset.opt === optId) {
          o.classList.add('selected');
          o.setAttribute('aria-checked', 'true');
        }
      });
    };

    window.selectTF = function(idx, val) {
      if (answered[QUESTIONS[idx].id]) return;
      answers[QUESTIONS[idx].id] = val;

      var btns = document.querySelectorAll('#options_' + idx + ' .tf-btn');
      btns.forEach(function(b) {
        b.classList.remove('selected');
        b.setAttribute('aria-pressed', 'false');
      });
      btns[val === 'true' ? 0 : 1].classList.add('selected');
      btns[val === 'true' ? 0 : 1].setAttribute('aria-pressed', 'true');
    };

    window.selectMatch = function(idx, itemId, targetId) {
      var qId = QUESTIONS[idx].id;
      if (!answers[qId]) answers[qId] = {};
      answers[qId][itemId] = targetId;
    };

    window.moveOrderItem = function(idx, btn, direction) {
      var li = btn.closest('.order-item');
      var list = li.parentNode;
      var items = Array.from(list.children);
      var i = items.indexOf(li);
      var newI = i + direction;
      if (newI < 0 || newI >= items.length) return;

      if (direction === -1) list.insertBefore(li, items[newI]);
      else list.insertBefore(li, items[newI].nextSibling);

      // Update numbers and arrows
      var updated = Array.from(list.children);
      updated.forEach(function(item, pos) {
        item.querySelector('.order-num').textContent = pos + 1;
        var arrows = item.querySelectorAll('.order-arrow-btn');
        if (arrows[0]) arrows[0].disabled = pos === 0;
        if (arrows[1]) arrows[1].disabled = pos === updated.length - 1;
      });

      btn.focus();
    };

    // ==========================================================================
    // SUBMIT QUESTION
    // ==========================================================================

    window.submitQuestion = function(idx) {
      var q = QUESTIONS[idx];
      if (answered[q.id]) return;
      if (!hasAnswer(q, idx)) {
        srAnnounce('الرجاء اختيار إجابة قبل التحقق.');
        return;
      }

      answered[q.id] = true;
      var isCorrect = checkAnswer(q, idx);
      results[q.id] = { correct: isCorrect };

      // Points + streak
      if (isCorrect) {
        totalPoints += POINTS_PER_Q;
        streak++;
        if (streak > maxStreak) maxStreak = streak;

        // Streak bonus
        if (streak >= 3) {
          var bonus = 5;
          totalPoints += bonus;
          showStreakBadge(streak);
          showFloatPts(bonus, 'streak-float');
        }

        showFloatPts(POINTS_PER_Q, 'correct-float');
      } else {
        streak = 0;
        hideStreakBadge();
      }

      updatePtsDisplay();

      // Visual feedback on options
      applyAnswerFeedback(q, idx, isCorrect);

      // Show feedback panel
      var fbPanel = document.getElementById('feedback_' + idx);
      fbPanel.className = 'feedback-panel show ' + (isCorrect ? 'correct-fb' : 'incorrect-fb');

      var fbTitle = isCorrect ? '> TEST PASSED' : '> TEST FAILED -- review needed';
      var fbText = isCorrect ? q.feedbackCorrect : q.feedbackIncorrect;

      var fbHtml = '<div class="fb-title" style="direction: ltr; text-align: left;">' + fbTitle + '</div>';
      fbHtml += '<div class="fb-text">' + fbText + '</div>';

      // Add trace table for loop questions
      if (q.traceTable) {
        fbHtml += '<table class="trace-table"><thead><tr>';
        q.traceTable.headers.forEach(function(h) { fbHtml += '<th>' + h + '</th>'; });
        fbHtml += '</tr></thead><tbody>';
        q.traceTable.rows.forEach(function(row) {
          fbHtml += '<tr>';
          row.forEach(function(cell) { fbHtml += '<td>' + cell + '</td>'; });
          fbHtml += '</tr>';
        });
        fbHtml += '</tbody></table>';
      }

      fbPanel.innerHTML = fbHtml;

      // Disable submit
      var submitBtn = document.getElementById('submitBtn_' + idx);
      submitBtn.disabled = true;
      submitBtn.textContent = isCorrect ? '&#10004; صحيح' : '&#10008; غير صحيح';

      // Report SCORM interaction
      reportInteraction(q, idx, isCorrect);

      // Save state
      saveState();

      // Focus feedback
      fbPanel.focus();

      srAnnounce(isCorrect ? 'إجابة صحيحة!' : 'إجابة غير صحيحة. راجع التوضيح.');
    };

    function hasAnswer(q, idx) {
      if (q.type === 'mcq') return !!answers[q.id];
      if (q.type === 'tf') return !!answers[q.id];
      if (q.type === 'matching') {
        var a = answers[q.id];
        return a && q.items.every(function(item) { return a[item.id]; });
      }
      if (q.type === 'ordering') return true; // always has an order
      return false;
    }

    function checkAnswer(q, idx) {
      if (q.type === 'mcq') {
        var correctOpt = q.options.find(function(o) { return o.correct; });
        return answers[q.id] === correctOpt.id;
      }
      if (q.type === 'tf') {
        return answers[q.id] === String(q.correct);
      }
      if (q.type === 'matching') {
        var a = answers[q.id];
        return q.items.every(function(item) {
          var target = q.targets.find(function(t) { return t.matchTo === item.id; });
          return a[item.id] === target.id;
        });
      }
      if (q.type === 'ordering') {
        var list = document.getElementById('orderList_' + idx);
        var orderItems = Array.from(list.children);
        // Save the order
        answers[q.id] = orderItems.map(function(li) { return li.dataset.id; });
        return q.items.every(function(item) {
          var pos = orderItems.findIndex(function(li) { return li.dataset.id === item.id; });
          return item.correctPosition === (pos + 1);
        });
      }
      return false;
    }

    function applyAnswerFeedback(q, idx, isCorrect) {
      if (q.type === 'mcq') {
        var opts = document.querySelectorAll('#options_' + idx + ' .mcq-option');
        opts.forEach(function(o) {
          o.classList.add('disabled');
          var optId = o.dataset.opt;
          var opt = q.options.find(function(op) { return op.id === optId; });
          if (opt.correct) o.classList.add('correct');
          else if (o.classList.contains('selected')) o.classList.add('incorrect');
        });
      } else if (q.type === 'tf') {
        var btns = document.querySelectorAll('#options_' + idx + ' .tf-btn');
        btns.forEach(function(b) { b.classList.add('disabled'); });
        // True button (index 0), False button (index 1)
        if (q.correct) {
          btns[0].classList.add('correct');
          if (answers[q.id] === 'false') btns[1].classList.add('incorrect');
        } else {
          btns[1].classList.add('correct');
          if (answers[q.id] === 'true') btns[0].classList.add('incorrect');
        }
      } else if (q.type === 'matching') {
        var rows = document.querySelectorAll('#options_' + idx + ' .match-row');
        var a = answers[q.id];
        q.items.forEach(function(item, i) {
          var target = q.targets.find(function(t) { return t.matchTo === item.id; });
          var isRowCorrect = a[item.id] === target.id;
          rows[i].classList.add(isRowCorrect ? 'correct' : 'incorrect');
          rows[i].querySelector('select').disabled = true;
        });
      } else if (q.type === 'ordering') {
        var list = document.getElementById('orderList_' + idx);
        var items = Array.from(list.children);
        items.forEach(function(li, i) {
          var qItem = q.items.find(function(it) { return it.id === li.dataset.id; });
          var isPos = qItem.correctPosition === (i + 1);
          li.classList.add(isPos ? 'correct' : 'incorrect');
          li.draggable = false;
          var arrows = li.querySelector('.order-arrows');
          if (arrows) arrows.style.display = 'none';
        });
      }
    }

    function reportInteraction(q, idx, isCorrect) {
      var n = idx;
      try {
        scorm.setValue('cmi.interactions.' + n + '.id', q.id);
        scorm.setValue('cmi.interactions.' + n + '.type', q.type === 'ordering' ? 'sequencing' : (q.type === 'matching' ? 'matching' : 'choice'));

        var learnerResp = '';
        var correctResp = '';
        if (q.type === 'mcq') {
          learnerResp = answers[q.id] || '';
          correctResp = q.options.find(function(o) { return o.correct; }).id;
        } else if (q.type === 'tf') {
          learnerResp = answers[q.id] || '';
          correctResp = String(q.correct);
        } else if (q.type === 'matching') {
          var a = answers[q.id] || {};
          learnerResp = q.items.map(function(it) { return it.id + '[.]' + (a[it.id] || ''); }).join(',');
          correctResp = q.items.map(function(it) { return it.id + '[.]' + q.targets.find(function(t) { return t.matchTo === it.id; }).id; }).join(',');
        } else if (q.type === 'ordering') {
          learnerResp = (answers[q.id] || []).join(',');
          correctResp = q.items.slice().sort(function(a, b) { return a.correctPosition - b.correctPosition; }).map(function(it) { return it.id; }).join(',');
        }

        scorm.setValue('cmi.interactions.' + n + '.student_response', learnerResp);
        scorm.setValue('cmi.interactions.' + n + '.correct_responses.0.pattern', correctResp);
        scorm.setValue('cmi.interactions.' + n + '.result', isCorrect ? 'correct' : 'wrong');
        scorm.commit();
      } catch(e) { /* ignore interaction errors */ }
    }

    // ==========================================================================
    // NAVIGATION
    // ==========================================================================

    var introSlide = document.getElementById('introSlide');
    var questionSlides = container.querySelectorAll('.question-slide');
    var resultsScreen = document.getElementById('resultsScreen');
    var quizNav = document.getElementById('quizNav');

    document.getElementById('startQuizBtn').addEventListener('click', function() {
      currentQ = 0;
      introSlide.classList.remove('active');
      quizNav.style.display = 'flex';
      showQuestion(0);
    });

    document.getElementById('qNextBtn').addEventListener('click', function() {
      if (currentQ < TOTAL_QUESTIONS - 1) {
        showQuestion(currentQ + 1);
      } else {
        showResults();
      }
    });

    document.getElementById('qPrevBtn').addEventListener('click', function() {
      if (currentQ > 0) {
        showQuestion(currentQ - 1);
      }
    });

    function showQuestion(idx) {
      currentQ = idx;

      // Hide all
      introSlide.classList.remove('active');
      resultsScreen.classList.remove('active', 'show');
      questionSlides.forEach(function(s) { s.classList.remove('active'); });

      // Show target
      var target = document.getElementById('qSlide_' + idx);
      if (target) target.classList.add('active');

      // Track start time
      if (!questionStartTimes[QUESTIONS[idx].id]) {
        questionStartTimes[QUESTIONS[idx].id] = Date.now();
      }

      // Update progress
      var pct = ((idx + 1) / TOTAL_QUESTIONS) * 100;
      document.getElementById('progress').style.width = pct + '%';

      // Update nav
      document.getElementById('qPageIndicator').innerHTML =
        '<span style="direction: ltr; unicode-bidi: embed;">Question ' + (idx + 1) + ' of ' + TOTAL_QUESTIONS + '</span>';
      document.getElementById('qPrevBtn').disabled = idx === 0;

      var nextBtn = document.getElementById('qNextBtn');
      if (idx === TOTAL_QUESTIONS - 1) {
        nextBtn.textContent = 'عرض النتائج';
      } else {
        nextBtn.innerHTML = 'التالي &#8592;';
      }

      // Setup ordering drag events (if not already answered)
      setupOrderingDrag(idx);

      saveState();
    }

    function setupOrderingDrag(idx) {
      var q = QUESTIONS[idx];
      if (q.type !== 'ordering' || answered[q.id]) return;

      var list = document.getElementById('orderList_' + idx);
      if (!list) return;

      var items = list.querySelectorAll('.order-item');
      var dragItem = null;

      items.forEach(function(item) {
        item.addEventListener('dragstart', function(e) {
          dragItem = item;
          item.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', '');
        });

        item.addEventListener('dragover', function(e) {
          e.preventDefault();
          if (this !== dragItem) this.classList.add('drag-over');
        });

        item.addEventListener('dragleave', function() {
          this.classList.remove('drag-over');
        });

        item.addEventListener('drop', function(e) {
          e.preventDefault();
          this.classList.remove('drag-over');
          if (dragItem && dragItem !== this) {
            var allItems = Array.from(list.children);
            var from = allItems.indexOf(dragItem);
            var to = allItems.indexOf(this);
            if (from < to) list.insertBefore(dragItem, this.nextSibling);
            else list.insertBefore(dragItem, this);
            updateOrderNums(list);
          }
        });

        item.addEventListener('dragend', function() {
          this.classList.remove('dragging');
          dragItem = null;
          list.querySelectorAll('.order-item.drag-over').forEach(function(el) { el.classList.remove('drag-over'); });
        });

        // Touch events
        var tItem = null, tClone = null;
        item.addEventListener('touchstart', function(e) {
          if (answered[q.id]) return;
          tItem = item;
          var rect = item.getBoundingClientRect();
          tClone = document.createElement('div');
          tClone.className = 'order-item';
          tClone.style.position = 'fixed';
          tClone.style.width = rect.width + 'px';
          tClone.style.zIndex = '9999';
          tClone.style.pointerEvents = 'none';
          tClone.style.opacity = '0.85';
          tClone.style.borderColor = 'var(--color-primary)';
          tClone.textContent = item.querySelector('.order-text').textContent;
          document.body.appendChild(tClone);
          item.classList.add('dragging');
        }, { passive: false });

        item.addEventListener('touchmove', function(e) {
          e.preventDefault();
          if (!tClone) return;
          var touch = e.touches[0];
          tClone.style.left = (touch.clientX - 40) + 'px';
          tClone.style.top = (touch.clientY - 20) + 'px';
          items.forEach(function(it) {
            it.classList.remove('drag-over');
            if (it === tItem) return;
            var r = it.getBoundingClientRect();
            if (touch.clientY >= r.top && touch.clientY <= r.bottom) it.classList.add('drag-over');
          });
        }, { passive: false });

        item.addEventListener('touchend', function(e) {
          if (!tItem || !tClone) return;
          var touch = e.changedTouches[0];
          var target = null;
          items.forEach(function(it) {
            it.classList.remove('drag-over');
            if (it === tItem) return;
            var r = it.getBoundingClientRect();
            if (touch.clientY >= r.top && touch.clientY <= r.bottom) target = it;
          });
          if (target) {
            var allItems = Array.from(list.children);
            var from = allItems.indexOf(tItem);
            var to = allItems.indexOf(target);
            if (from < to) list.insertBefore(tItem, target.nextSibling);
            else list.insertBefore(tItem, target);
            updateOrderNums(list);
          }
          tItem.classList.remove('dragging');
          document.body.removeChild(tClone);
          tClone = null;
          tItem = null;
        });
      });
    }

    function updateOrderNums(list) {
      var items = Array.from(list.children);
      items.forEach(function(item, i) {
        item.querySelector('.order-num').textContent = i + 1;
        var arrows = item.querySelectorAll('.order-arrow-btn');
        if (arrows[0]) arrows[0].disabled = i === 0;
        if (arrows[1]) arrows[1].disabled = i === items.length - 1;
      });
    }

    // ==========================================================================
    // RESULTS SCREEN
    // ==========================================================================

    function showResults() {
      // Hide everything
      introSlide.classList.remove('active');
      questionSlides.forEach(function(s) { s.classList.remove('active'); });
      quizNav.style.display = 'none';

      // Calculate score
      var correctCount = 0;
      QUESTIONS.forEach(function(q) {
        if (results[q.id] && results[q.id].correct) correctCount++;
      });

      var scorePct = Math.round((correctCount / TOTAL_QUESTIONS) * 100);
      var passed = scorePct >= PASSING_SCORE;

      // Pass bonus
      if (passed) {
        totalPoints += 200;
        if (scorePct === 100) totalPoints += 300;
      }
      updatePtsDisplay();

      // Update progress
      document.getElementById('progress').style.width = '100%';

      // Build results HTML
      var h = '';

      // Terminal result
      h += '<div class="result-terminal">';
      h += '<span style="color: var(--syntax-comment);">// Post-test results</span><br>';
      h += '<span style="color: var(--syntax-keyword);">const</span> <span style="color: var(--syntax-variable);">score</span> = <span style="color: var(--syntax-number);">' + scorePct + '%</span>;<br>';
      h += '<span style="color: var(--syntax-keyword);">const</span> <span style="color: var(--syntax-variable);">correct</span> = <span style="color: var(--syntax-number);">' + correctCount + '</span> / <span style="color: var(--syntax-number);">' + TOTAL_QUESTIONS + '</span>;<br>';
      h += '<span style="color: var(--syntax-keyword);">const</span> <span style="color: var(--syntax-variable);">status</span> = <span style="color: ' + (passed ? 'var(--syntax-string)' : 'var(--color-error)') + ';">"' + (passed ? 'PASSED' : 'FAILED') + '"</span>;<br><br>';
      h += '<span style="color: ' + (passed ? 'var(--color-success)' : 'var(--color-error)') + '; font-weight: 700;">' + (passed ? '> BUILD PASSED &#10004;' : '> BUILD FAILED -- review needed') + '</span>';
      h += '</div>';

      // Score circle
      h += '<div class="result-score-circle ' + (passed ? 'pass' : 'fail') + '">';
      h += '<div class="score-pct">' + scorePct + '%</div>';
      h += '<div class="score-label">' + correctCount + '/' + TOTAL_QUESTIONS + '</div>';
      h += '</div>';

      // Message
      var msgAr = '';
      if (scorePct >= 90) msgAr = 'ممتاز! أنت تفهم التفكير الحاسوبي حقاً! أنت جاهز للوحدة الثانية!';
      else if (scorePct >= 70) msgAr = 'أحسنت! نجحت بنسبة ' + scorePct + '%. لتعزيز فهمك أكثر، راجع المواضيع التي فقدت فيها نقاطاً.';
      else if (scorePct >= 50) msgAr = 'حصلت على ' + scorePct + '% -- أنت في الطريق الصحيح! تحتاج 70% للنجاح. راجع المجالات أدناه وحاول مرة أخرى.';
      else msgAr = 'حصلت على ' + scorePct + '%. هذا يخبرنا أي المجالات نركز عليها. نوصي بمراجعة الدروس أدناه. تذكّر: الفهم ينمو مع كل محاولة.';

      h += '<p style="font-size: 1rem; line-height: 1.8; color: var(--color-text-secondary); margin: var(--space-lg) auto; max-width: 600px;">' + msgAr + '</p>';

      // Objective breakdown
      var objScores = { 'TO-1': { total: 0, correct: 0 }, 'TO-2': { total: 0, correct: 0 }, 'TO-3': { total: 0, correct: 0 }, 'TO-4': { total: 0, correct: 0 } };
      QUESTIONS.forEach(function(q) {
        objScores[q.objective].total++;
        if (results[q.id] && results[q.id].correct) objScores[q.objective].correct++;
      });

      h += '<h3 style="font-size: 1rem; margin: var(--space-xl) 0 var(--space-md);">التفصيل حسب الهدف:</h3>';
      h += '<div class="obj-breakdown">';

      var objLabels = {
        'TO-1': 'مبادئ التفكير الحاسوبي',
        'TO-2': 'التفكير المنطقي والخوارزمي',
        'TO-3': 'التكرار والاختيار',
        'TO-4': 'تقييم الخوارزميات'
      };

      Object.keys(objScores).forEach(function(key) {
        var obj = objScores[key];
        var pct = Math.round((obj.correct / obj.total) * 100);
        var cls = pct >= 70 ? 'good' : 'weak';
        h += '<div class="obj-card">';
        h += '<div class="obj-name">' + objLabels[key] + ' <span style="direction: ltr; font-family: var(--font-mono); font-size: 0.7rem;">(' + key + ')</span></div>';
        h += '<div class="obj-score ' + cls + '">' + obj.correct + '/' + obj.total + ' (' + pct + '%)</div>';
        h += '</div>';
      });
      h += '</div>';

      // Remediation links for weak areas
      if (!passed) {
        var remMap = {
          'TO-1': { label: 'مبادئ التفكير الحاسوبي', scos: ['SCO 04: محاضرة CT', 'SCO 07: نشاط CT'] },
          'TO-2': { label: 'التفكير المنطقي والخوارزمي', scos: ['SCO 06: فيديو المنطق', 'SCO 08: نشاط المنطق', 'SCO 09: نشاط الخوارزمي'] },
          'TO-3': { label: 'التكرار والاختيار', scos: ['SCO 10: محاضرة التحكم', 'SCO 12: نشاط التكرار', 'SCO 13: نشاط الاختيار'] },
          'TO-4': { label: 'تقييم الخوارزميات', scos: ['SCO 14: نشاط مثال خوارزمي', 'SCO 15: نقاش الأخطاء'] }
        };

        h += '<div class="remediation-links">';
        h += '<h4>&#128218; راجع هذه الدروس لتحسين نتيجتك:</h4>';

        Object.keys(objScores).forEach(function(key) {
          if (Math.round((objScores[key].correct / objScores[key].total) * 100) < 70) {
            remMap[key].scos.forEach(function(sco) {
              h += '<span class="remediation-link">' + sco + '</span>';
            });
          }
        });
        h += '</div>';
      }

      // Badge and points
      h += '<div style="margin-top: var(--space-xl); padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--color-border-highlight); border-radius: var(--radius-md);">';
      h += '<div style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--color-text-muted); direction: ltr; text-align: left;">';
      h += '// gamification summary<br>';
      h += 'points_earned: ' + totalPoints + '<br>';
      h += 'max_streak: ' + maxStreak + '<br>';
      if (passed) h += 'badge_unlocked: "Algorithm Verified" &#128274;<br>';
      if (scorePct === 100) h += 'bonus_badge: "Perfectionist" &#127942;<br>';
      h += '</div>';
      h += '</div>';

      document.getElementById('resultsContent').innerHTML = h;
      resultsScreen.classList.add('active', 'show');

      // SCORM reporting
      scorm.setValue('cmi.core.score.raw', String(scorePct));
      scorm.setValue('cmi.core.score.min', '0');
      scorm.setValue('cmi.core.score.max', '100');
      scorm.setLessonStatus(passed ? 'passed' : 'failed');

      var duration = Math.floor((Date.now() - startTime) / 1000);
      var hrs = Math.floor(duration / 3600);
      var mins = Math.floor((duration % 3600) / 60);
      var secs = duration % 60;
      scorm.setValue('cmi.core.session_time',
        String(hrs).padStart(4, '0') + ':' +
        String(mins).padStart(2, '0') + ':' +
        String(secs).padStart(2, '0'));

      scorm.commit();
      saveState();
    }

    // ==========================================================================
    // UTILITIES
    // ==========================================================================

    function updatePtsDisplay() {
      document.getElementById('ptsValue').textContent = totalPoints;
    }

    function showStreakBadge(count) {
      var badge = document.getElementById('streakBadge');
      badge.classList.add('show');
      document.getElementById('streakCount').textContent = count;
    }

    function hideStreakBadge() {
      document.getElementById('streakBadge').classList.remove('show');
    }

    function showFloatPts(pts, cls) {
      var badge = document.getElementById('ptsBadge');
      var rect = badge.getBoundingClientRect();
      var el = document.createElement('div');
      el.className = 'pts-float ' + cls;
      el.textContent = '+' + pts;
      el.style.left = rect.left + 'px';
      el.style.top = (rect.top - 10) + 'px';
      document.body.appendChild(el);
      setTimeout(function() { if (el.parentNode) el.parentNode.removeChild(el); }, 1100);
    }

    function srAnnounce(msg) {
      var el = document.getElementById('srAnnounce');
      if (el) el.textContent = msg;
    }

    function saveState() {
      var state = {
        sco: 'sco_18',
        currentQ: currentQ,
        answers: answers,
        answered: answered,
        results: results,
        totalPoints: totalPoints,
        streak: streak
      };
      try {
        scorm.setValue('cmi.suspend_data', JSON.stringify(state));
        scorm.commit();
      } catch(e) {}
    }

    window.addEventListener('beforeunload', function() { saveState(); });

    // Resume if midway
    if (savedState && savedState.sco === 'sco_18' && currentQ >= 0) {
      introSlide.classList.remove('active');
      quizNav.style.display = 'flex';
      showQuestion(currentQ);
    }

  })();
  </script>
</body>
</html>
